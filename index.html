<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0">
    <title>PG Coin Mining & Games</title>
    <style>
        /* --- Global Styles & Fonts --- */
        @import url('https://fonts.googleapis.com/css2?family=Hind+Siliguri:wght@400;600;700&display=swap');

        :root {
            --primary-color: #00e5ff;
            --secondary-color: #7b2cbf;
            --background-color: #0d0c22;
            --surface-color: #191835;
            --text-color: #e0e0e0;
            --glow-color: rgba(0, 229, 255, 0.7);
            --green-glow: #00ff7f;
            --red-glow: #ff4d4d;
            --orange-color: #e67e22;
            --yellow-color: #f1c40f;
        }

        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
            overflow: hidden;
        }

        body {
            font-family: 'Hind Siliguri', sans-serif;
            background-color: var(--background-color);
            color: var(--text-color);
            display: flex;
            justify-content: center;
            touch-action: none;
        }

        #app-wrapper {
            width: 100%;
            height: 100%;
            max-width: 420px;
            position: relative;
            display: flex;
            flex-direction: column;
            background: var(--background-color);
        }

        /* --- View Management --- */
        .view-container {
            flex-grow: 1;
            overflow-y: auto;
            -ms-overflow-style: none;
            scrollbar-width: none;
            position: relative;
        }
        .view-container::-webkit-scrollbar { display: none; }

        .view {
            display: none;
            width: 100%;
            min-height: 100%;
            position: absolute;
            top: 0; left: 0;
            animation: fadeIn 0.5s ease-in-out;
            flex-direction: column;
            justify-content: flex-start;
            align-items: center;
            box-sizing: border-box;
        }
        .view.active { display: flex; }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.98); }
            to { opacity: 1; transform: scale(1); }
        }

        /* --- Common Page Styles --- */
        .page-container {
            width: 100%;
            padding: 25px;
            text-align: center;
            box-sizing: border-box;
        }
        .page-header {
            display: flex; align-items: center; justify-content: center;
            position: relative; margin-bottom: 20px;
        }
        .back-button {
            position: absolute; left: 0; background: var(--surface-color);
            border: 1px solid var(--secondary-color); color: var(--primary-color);
            width: 40px; height: 40px; border-radius: 50%;
            font-size: 24px; cursor: pointer; display: flex;
            align-items: center; justify-content: center;
        }
        .page-title {
            color: var(--primary-color); font-size: 1.8em;
            text-shadow: 0 0 10px var(--glow-color); margin: 0;
        }

        /* --- Mining App Styles --- */
        #mining-section .container {
            width: 100%;
            min-height: 100%;
            background: linear-gradient(145deg, var(--surface-color), #211f42);
            padding: 25px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
            text-align: center;
            display: flex; flex-direction: column;
            justify-content: space-between;
            border: 2px solid var(--secondary-color);
            box-sizing: border-box;
        }
        #top-balance-bar {
            background: rgba(0, 0, 0, 0.3); padding: 10px 20px; border-radius: 12px;
            margin-bottom: 15px; display: flex; justify-content: space-between;
            align-items: center; border: 1px solid var(--secondary-color);
        }
        #top-balance-bar div { font-size: 1.2em; font-weight: 600; }
        #top-balance-bar #pg-balance-top { color: var(--primary-color); }
        #top-balance-bar #usd-balance-top { color: var(--green-glow); }

        #mining-section h1 { color: var(--primary-color); margin-bottom: 10px; font-size: 2.2em; text-shadow: 0 0 10px var(--glow-color); }
        .mining-display {
            background-color: rgba(0,0,0,0.2); padding: 20px; border-radius: 20px;
            margin-bottom: 15px; border: 1px solid var(--secondary-color);
            box-shadow: inset 0 0 15px rgba(0,0,0,0.3);
        }
        .mining-display h2 { margin: 0 0 10px 0; color: var(--text-color); font-weight: 400; font-size: 1.3em; }
        #balance { font-size: 2.5em; font-weight: 700; color: var(--primary-color); text-shadow: 0 0 8px var(--glow-color); word-wrap: break-word; margin-bottom: 15px; }
        
        .action-boxes { display: flex; gap: 15px; margin-bottom: 15px; }
        .action-box {
            flex: 1; background: rgba(0,0,0,0.2); border: 1px solid var(--secondary-color);
            border-radius: 15px; padding: 15px 10px; cursor: pointer; transition: background-color 0.2s;
        }
        .action-box:hover { background-color: rgba(0, 229, 255, 0.1); }
        .action-box svg { width: 32px; height: 32px; margin-bottom: 5px; color: var(--primary-color); }
        .action-box span { font-size: 1em; font-weight: 600; color: var(--text-color); }

        #status-container { font-size: 1.2em; margin-bottom: 10px; }
        #status.mining { color: var(--green-glow); font-weight: 600; animation: glow-green 1.5s infinite alternate; }
        #status.stopped { color: var(--red-glow); font-weight: 600; }
        @keyframes glow-green {
            from { text-shadow: 0 0 5px var(--green-glow), 0 0 10px var(--green-glow); }
            to { text-shadow: 0 0 15px var(--green-glow), 0 0 20px var(--green-glow); }
        }
        #timer { font-size: 1.3em; font-weight: 600; color: #ccc; min-height: 25px; }
        
        .button-row {
            display: flex;
            gap: 10px;
            width: 100%;
            margin-bottom: 15px;
        }

        #mining-button, #watch-ad-button {
            flex: 1;
            padding: 15px 10px;
            font-size: 1.1em; /* Adjusted for smaller size */
            font-weight: 700;
            font-family: 'Hind Siliguri', sans-serif;
            border: none;
            border-radius: 12px; /* Adjusted */
            cursor: pointer;
            transition: all 0.3s ease;
            box-sizing: border-box;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        #mining-button {
            background: linear-gradient(45deg, var(--primary-color), var(--secondary-color));
            color: var(--background-color);
            box-shadow: 0 5px 20px rgba(123, 44, 191, 0.4);
        }
        #mining-button:hover { transform: translateY(-3px); box-shadow: 0 8px 25px rgba(0, 229, 255, 0.5); }
        #mining-button:disabled { background: #555; color: #999; cursor: not-allowed; box-shadow: none; transform: none; }
        
        #watch-ad-button {
             background: linear-gradient(45deg, var(--yellow-color), var(--orange-color));
             color: var(--background-color);
        }
        #watch-ad-button svg {
            width: 20px;
            height: 20px;
        }
        
        .nav-bar {
            width: 100%; max-width: 420px;
            display: flex; justify-content: space-around; align-items: center; background: rgba(0,0,0,0.5);
            padding: 10px 5px; border-top: 1px solid var(--secondary-color);
            backdrop-filter: blur(5px);
            box-sizing: border-box;
            flex-shrink: 0;
        }
        .nav-bar button {
            background: transparent; border: none; color: var(--text-color); cursor: pointer;
            text-align: center; font-size: 0.8em; display: flex; flex-direction: column;
            align-items: center; gap: 5px; transition: color 0.2s; flex: 1;
        }
        .nav-bar button:hover, .nav-bar button.active { color: var(--primary-color); }
        .nav-bar svg { width: 28px; height: 28px; }
        
        /* --- Create Task & Deposit Section --- */
        #create-task-section .balance-info {
            font-size: 1.2em; margin-bottom: 20px;
            background: rgba(0,0,0,0.2); padding: 10px; border-radius: 10px;
        }
        #create-task-section .balance-info strong { color: var(--green-glow); }
        #create-task-section .task-package-grid { display: grid; grid-template-columns: 1fr; gap: 15px; width: 100%; margin-bottom: 20px; }
        .task-package-card {
            background: linear-gradient(145deg, var(--surface-color), #211f42);
            border: 2px solid var(--secondary-color); border-radius: 15px; padding: 15px;
            text-align: left; cursor: pointer; position: relative;
        }
        .task-package-card:has(input:checked) { border-color: var(--primary-color); box-shadow: 0 0 15px var(--glow-color); }
        .task-package-card input[type="radio"] { position: absolute; opacity: 0; }
        .task-package-card h3 { color: var(--primary-color); margin: 0 0 10px 0; }
        .task-package-card p { margin: 0; color: var(--text-color); font-size: 1.1em; }
        .task-package-card p strong { color: var(--yellow-color); }
        
        #create-task-btn, #deposit-usdt-btn {
            width: 100%; padding: 15px; font-size: 1.3em; font-weight: 700;
            color: var(--background-color); border: none; border-radius: 10px; cursor: pointer;
            margin-top: 10px;
        }
        #create-task-btn { background: linear-gradient(45deg, var(--green-glow), var(--primary-color)); }
        #deposit-usdt-btn { background: linear-gradient(45deg, var(--yellow-color), var(--orange-color)); }

        /* --- Invite Section --- */
        #invite-section .invite-box { background: var(--surface-color); padding: 25px; border-radius: 15px; border: 1px solid var(--secondary-color); }
        #invite-section h3 { margin-top: 0; color: var(--primary-color); }
        #invite-section p { color: #ccc; }
        #invite-section .referral-link-container { display: flex; margin-top: 20px; }
        #invite-section #referral-link { flex-grow: 1; background: var(--background-color); border: 1px solid var(--secondary-color); border-radius: 8px 0 0 8px; padding: 12px; color: white; }
        #invite-section #copy-ref-btn { background: var(--primary-color); color: var(--background-color); border: none; padding: 0 15px; border-radius: 0 8px 8px 0; font-weight: bold; cursor: pointer; }

        /* --- Deposit Modal --- */
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.6); justify-content: center; align-items: center; }
        .modal-content { background: var(--surface-color); padding: 25px; border-radius: 15px; border: 1px solid var(--primary-color); text-align: center; width: 90%; max-width: 380px; box-shadow: 0 0 25px var(--glow-color); position: relative; }
        .close-modal-btn { position: absolute; top: 10px; right: 15px; color: #aaa; font-size: 28px; font-weight: bold; cursor: pointer; }
        #deposit-qr-code { background: white; padding: 10px; border-radius: 8px; margin: 15px auto; display: inline-block; }
        #deposit-address { background: var(--background-color); padding: 10px; border-radius: 8px; word-wrap: break-word; margin-bottom: 10px; font-family: monospace; }
        #copy-deposit-addr-btn { background: var(--primary-color); color: var(--background-color); padding: 10px 20px; border-radius: 8px; border: none; cursor: pointer; font-weight: bold; }
        
        /* --- Other Sections --- */
        #tasks-section .task-placeholder { margin-top: 50px; font-size: 1.3em; color: #aaa; }
        #withdrawal-section .withdrawal-form {
            background: var(--surface-color); padding: 20px; border-radius: 15px;
            border: 1px solid var(--secondary-color); margin-bottom: 25px;
        }
        #withdrawal-section h3 { color: var(--primary-color); margin-top: 0; }
        #withdrawal-section p { color: #ccc; font-size: 0.9em; }
        #withdrawal-section input {
            width: 100%; background: var(--background-color); border: 1px solid var(--secondary-color);
            border-radius: 8px; padding: 12px; color: white; font-size: 1em;
            margin-bottom: 15px; box-sizing: border-box;
        }
        #withdrawal-section .withdraw-btn-group { display: flex; gap: 10px; }
        #withdrawal-section .withdraw-btn {
            flex: 1; padding: 12px; border: none; border-radius: 8px; font-weight: bold;
            font-size: 1em; cursor: pointer;
        }
        .withdraw-btn.bkash { background-color: #e2136e; color: white; }
        .withdraw-btn.binance { background-color: #f0b90b; color: #1e2329; }

        /* --- Game Section --- */
        #game-section { background-color: #333; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        #game-section #back-to-mining-game { position: absolute; top: 15px; right: 15px; z-index: 20; background: var(--yellow-color); color: #333; border: none; padding: 8px 15px; border-radius: 10px; font-family: 'Hind Siliguri', sans-serif; cursor: pointer; font-weight: bold; }
        #game-section h1 { color: var(--primary-color); text-shadow: 2px 2px 4px #000; }
        #game-section #game-container { position: relative; width: 80vw; max-width: 600px; height: 70vh; max-height: 700px; background: #001f3f; border: 3px solid var(--secondary-color); border-radius: 10px; overflow: hidden; cursor: crosshair; }
        #game-section .falling-object { position: absolute; font-size: 28px; user-select: none; cursor: pointer; transition: transform 0.1s ease-out; padding: 12px; text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.5); }
        #game-section .falling-object.collected { animation: collect-effect 0.3s ease-out forwards; pointer-events: none; }
        @keyframes collect-effect { 0% { transform: scale(1); opacity: 1; } 100% { transform: scale(1.5); opacity: 0; } }
        #game-section #scoreboard { margin-bottom: 15px; font-size: 1.2em; background-color: rgba(0, 0, 0, 0.3); padding: 10px 20px; border-radius: 8px; color: white; border: 1px solid var(--secondary-color); }
        #game-section #scoreboard span { font-weight: bold; color: var(--primary-color); }
        #game-section #scoreboard #timer-value { color: var(--yellow-color); }
        #game-section #scoreboard #usdt-score { color: var(--green-glow); }
        #game-section #game-over { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(0, 0, 0, 0.85); padding: 30px; border-radius: 15px; text-align: center; display: none; z-index: 10; width: 80%; border: 1px solid var(--primary-color); }
        #game-section #game-over-title { margin-top: 0; color: var(--red-glow); }
        #game-section #restart-button { padding: 12px 25px; font-size: 1.1em; cursor: pointer; background-color: var(--green-glow); color: var(--background-color); border: none; border-radius: 5px; margin-top: 15px; font-weight: bold; }
        #game-section #restart-button:hover { filter: brightness(1.1); }
    </style>
    <!-- QR Code Library -->
    <script src="https://cdn.jsdelivr.net/npm/qrcode-generator/qrcode.js"></script>
    <!-- Telegram WebApp SDK -->
    <script src="https://telegram.org/js/web-app.js"></script>
    <!-- Ad SDKs -->
    <script src="https://ad.gigapub.tech/script?id=1470"></script>
    <script src='//libtl.com/sdk.js' data-zone='9689843' data-sdk='show_9689843'></script>
</head>
<body>
    <div id="app-wrapper">
        <div class="view-container">
            <!-- Mining App View -->
            <div id="mining-section" class="view active">
                <div class="container">
                    <div>
                        <div id="top-balance-bar">
                            <div>PG <span id="pg-balance-top">0.0000</span></div>
                            <div>$ <span id="usd-balance-top">0.00</span></div>
                        </div>
                        <h1>PG Coin Mining</h1>
                        <div class="mining-display">
                            <h2>Your Balance</h2>
                            <p id="balance">0.0000 PG</p>
                            <div class="action-boxes">
                                <div class="action-box" onclick="showView('invite-section')">
                                    <svg fill="currentColor" viewBox="0 0 24 24"><path d="M18 2h-3a4 4 0 0 0-4 4v2H8v4h3v8h4v-8h3l1-4h-4V6a1 1 0 0 1 1-1h2z"/></svg>
                                    <span>Invite</span>
                                </div>
                                <div class="action-box" onclick="handleConvertClick()">
                                    <svg fill="currentColor" viewBox="0 0 24 24"><path d="m21.435 2.585-2.02 2.02c-1.39-1.12-3.23-1.6-5.06-1.6h-1.355L14.435 6H7.565L6.13 3.005H5.06c-3.61 0-6.68 2.68-7.04 6.22l2.12.35c.32-2.82 2.89-5.07 5.86-5.07h.75l1.435 3h6.87l1.435-3h.75c2.97 0 5.54 2.25 5.86 5.07l2.12-.35c-.35-3.54-3.42-6.22-7.03-6.22zm-18.87 18.83 2.02-2.02c1.39 1.12 3.23 1.6 5.06 1.6h1.355L9.565 18h6.87l1.435 2.995h1.075c3.61 0 6.68-2.68 7.04-6.22l-2.12-.35c-.32 2.82-2.89 5.07-5.86 5.07h-.75L14.565 21H7.695l-1.435-3h-.75c-2.97 0-5.54-2.25-5.86-5.07l-2.12.35c.35 3.54 3.42 6.22 7.03 6.22z"/></svg>
                                    <span>CVT</span>
                                </div>
                            </div>
                            <p id="status-container">Status: <span id="status" class="stopped">Stopped</span></p>
                            <p id="timer"></p>
                        </div>
                        <div class="button-row">
                           <button id="mining-button">Start Mining</button>
                           <button id="watch-ad-button">
                                <svg fill="currentColor" viewBox="0 0 24 24"><path d="M21.406 8.442a2.368 2.368 0 0 0-1.666-1.696C18.15 6.25 12 6.25 12 6.25s-6.15 0-7.74.496a2.368 2.368 0 0 0-1.666 1.696C2.1 10.046 2.1 12 2.1 12s0 1.954.494 3.558a2.368 2.368 0 0 0 1.666 1.696c1.59.496 7.74.496 7.74.496s6.15 0 7.74-.496a2.368 2.368 0 0 0 1.666-1.696C21.9 13.954 21.9 12 21.9 12s0-1.954-.494-3.558zM9.9 14.5v-5l4.5 2.5-4.5 2.5z"/></svg>
                                <span>Daily Claim Rewards</span>
                           </button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Other Views -->
            <div id="tasks-section" class="view">
                <div class="page-container">
                    <div class="page-header">
                        <button class="back-button" onclick="showView('mining-section')">‚Äπ</button>
                        <h2 class="page-title">Available Tasks</h2>
                    </div>
                    <p class="task-placeholder">New tasks from advertisers will appear here!</p>
                </div>
            </div>

            <div id="invite-section" class="view">
                <div class="page-container">
                    <div class="page-header">
                        <button class="back-button" onclick="showView('mining-section')">‚Äπ</button>
                        <h2 class="page-title">Invite Friends</h2>
                    </div>
                    <div class="invite-box">
                        <h3>Share Your Link</h3>
                        <p>Invite friends and earn <strong>2.5 HP</strong> for each referral!</p>
                        <div class="referral-link-container">
                            <input type="text" id="referral-link" readonly value="Loading...">
                            <button id="copy-ref-btn" onclick="copyReferralLink()">Copy</button>
                        </div>
                    </div>
                </div>
            </div>
        
            <div id="create-task-section" class="view">
                <div class="page-container">
                     <div class="page-header">
                        <button class="back-button" onclick="showView('mining-section')">‚Äπ</button>
                        <h2 class="page-title">Create a Task</h2>
                    </div>
                    <div class="balance-info">Your USDT Balance: <strong id="task-usdt-balance">0.00</strong></div>
                    <p>Deposit USDT to create tasks for others.</p>
                    
                    <div id="task-package-form">
                        <div class="task-package-grid">
                            <label class="task-package-card"><input type="radio" name="task_package" value="0.5"><h3>500 Tasks</h3><p>Price: <strong>$0.50</strong></p></label>
                            <label class="task-package-card"><input type="radio" name="task_package" value="0.9"><h3>1,000 Tasks</h3><p>Price: <strong>$0.90</strong></p></label>
                            <label class="task-package-card"><input type="radio" name="task_package" value="1.7"><h3>2,000 Tasks</h3><p>Price: <strong>$1.70</strong></p></label>
                            <label class="task-package-card"><input type="radio" name="task_package" value="3.5"><h3>5,000 Tasks</h3><p>Price: <strong>$3.50</strong></p></label>
                            <label class="task-package-card"><input type="radio" name="task_package" value="8"><h3>10,000 Tasks</h3><p>Price: <strong>$8.00</strong></p></label>
                        </div>
                        <button id="create-task-btn" onclick="handleCreateTask()">Create Task</button>
                        <button id="deposit-usdt-btn" onclick="showDepositModal()">Deposit USDT</button>
                    </div>
                </div>
            </div>
            
            <div id="withdrawal-section" class="view">
                <div class="page-container">
                    <div class="page-header">
                        <button class="back-button" onclick="showView('mining-section')">‚Äπ</button>
                        <h2 class="page-title">Withdrawal</h2>
                    </div>
                    <div class="withdrawal-form">
                        <h3>Withdraw PG Coin</h3>
                        <p>Available: <span id="withdraw-pg-balance">0.0000</span> PG</p>
                        <p>Minimum: 25 PG | Rate: 25 PG = 60 BDT / $0.50</p>
                        <input type="number" id="pg-withdraw-amount" placeholder="Amount (e.g., 25)">
                        <input type="text" id="pg-withdraw-address" placeholder="bKash Number or Binance UID">
                        <div class="withdraw-btn-group">
                            <button class="withdraw-btn bkash" onclick="handleWithdraw('pg', 'bkash')">bKash</button>
                            <button class="withdraw-btn binance" onclick="handleWithdraw('pg', 'binance')">Binance</button>
                        </div>
                    </div>
                    <div class="withdrawal-form">
                        <h3>Withdraw USDT</h3>
                        <p>Available: <span id="withdraw-usdt-balance">0.000000</span> USDT</p>
                        <p>Minimum: 1 USDT | Rate: 1 USDT = 120 BDT</p>
                        <input type="number" id="usdt-withdraw-amount" placeholder="Amount (e.g., 1.5)">
                        <input type="text" id="usdt-withdraw-address" placeholder="bKash Number or Binance UID">
                        <div class="withdraw-btn-group">
                            <button class="withdraw-btn bkash" onclick="handleWithdraw('usdt', 'bkash')">bKash</button>
                            <button class="withdraw-btn binance" onclick="handleWithdraw('usdt', 'binance')">Binance</button>
                        </div>
                    </div>
                </div>
            </div>
        
            <div id="game-section" class="view">
                <button id="back-to-mining-game">Go Back</button>
                <h1>‚ùÑÔ∏è Snow & Coin Catcher üí∏</h1>
                <div id="scoreboard">
                    <span>Score: </span><span id="score">0</span> | 
                    <span>Missed: </span><span id="missed">0</span> |
                    <span>USDT: </span><span id="usdt-score">0.000000</span> |
                    <span>Time: </span><span id="timer-value">60</span>s
                </div>
                <div id="game-container">
                    <div id="game-over">
                        <h2 id="game-over-title">Game Over!</h2>
                        <p>Your Final Score: <span id="final-score">0</span></p>
                        <p>Your Total USDT: <span id="final-usdt-score">0.000000</span></p>
                        <button id="restart-button">Play Again</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="nav-bar">
             <button onclick="showView('mining-section')" class="active">
                <svg fill="currentColor" viewBox="0 0 24 24"><path d="M12.71 2.29a1 1 0 0 0-1.42 0l-9 9a1 1 0 0 0 0 1.42A1 1 0 0 0 3 13h1v7a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-7h1a1 1 0 0 0 .71-1.71zM18 20H6v-9.59l6-6 6 6z"/></svg>
                <span>Home</span></button>
             <button onclick="showView('tasks-section')">
                <svg fill="currentColor" viewBox="0 0 24 24"><path d="M15.54 10.5h-1a.5.5 0 0 1 0-1h1a.5.5 0 0 1 0 1zm-5.08 0H7.2a.5.5 0 0 1 0-1h3.26a.5.5 0 0 1 0 1zm5.08 4h-1a.5.5 0 0 1 0-1h1a.5.5 0 0 1 0 1zm-5.08 0H7.2a.5.5 0 0 1 0-1h3.26a.5.5 0 0 1 0 1zM21 4H3a1 1 0 0 0-1 1v14a1 1 0 0 0 1 1h18a1 1 0 0 0 1-1V5a1 1 0 0 0-1-1zm-1 14H4V6h16z"/></svg>
                <span>Tasks</span></button>
            <button onclick="showView('create-task-section')">
                <svg fill="currentColor" viewBox="0 0 24 24"><path d="M20.29 4.29l-1.58 1.58C19.8 6.45 20 7.21 20 8s-.2 1.55-.58 2.13l1.58 1.58c.87-1.12 1-2.67 1-4.71s-.13-3.59-1-4.71zM4 8c0-.79.2-1.55.59-2.13L2.71 4.29C1.83 5.41 1.71 6.96 1.71 9s.13 3.59 1 4.71l1.88-1.88C4.2 11.27 4 10.53 4 9.79V8zm12-2h-4v4h4V6zM12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8z"/></svg>
                <span>Advertise</span></button>
            <button onclick="showView('withdrawal-section')">
                <svg fill="currentColor" viewBox="0 0 24 24"><path d="M5 20a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V8h2V6h-4V4a2 2 0 0 0-2-2H9a2 2 0 0 0-2 2v2H3v2h2v12zM9 4h6v2H9V4zm10 6H5v10h14V10z"></path><path d="M11 12h2v6h-2z"/></svg>
                <span>Withdraw</span></button>
            <button onclick="showView('game-section')">
                <svg fill="currentColor" viewBox="0 0 24 24"><path d="M3.5 11c.41 0 .79-.13 1.11-.34a.5.5 0 0 1 .45.89 2.49 2.49 0 0 1-3.12 0 .5.5 0 0 1 .45-.89A1.49 1.49 0 0 1 3.5 11zm17 0a1.49 1.49 0 0 1 1.11.34.5.5 0 0 1 .45-.89 2.49 2.49 0 0 1-3.12 0 .5.5 0 0 1 .45.89A1.49 1.49 0 0 1 20.5 11zM12 4.5a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-1 0v-1a.5.5 0 0 1 .5-.5zM6.27 6.27a.5.5 0 0 1 .71 0l.7.7a.5.5 0 0 1-.7.71l-.71-.7a.5.5 0 0 1 0-.71zm11.46 0a.5.5 0 0 1 .71.71l-.7.7a.5.5 0 0 1-.71-.7l.7-.7a.5.5 0 0 1 .01 0zM12 13a3 3 0 1 1 3-3 3 3 0 0 1-3 3zm0-5a2 2 0 1 0 2 2 2 2 0 0 0-2-2zm-1 12.5a.5.5 0 0 1 .5-.5h1a.5.5 0 0 1 0 1h-1a.5.5 0 0 1-.5-.5zM12 22a7 7 0 0 1-7-7 .5.5 0 0 1 1 0 6 6 0 0 0 12 0 .5.5 0 0 1 1 0 7 7 0 0 1-7 7z"/></svg>
                <span>Game</span></button>
        </div>
    </div>
    
    <!-- Deposit Modal -->
    <div id="deposit-modal" class="modal">
        <div class="modal-content">
            <span class="close-modal-btn" onclick="closeDepositModal()">&times;</span>
            <h3>Deposit USDT (BEP20)</h3>
            <p>Send only USDT on the BEP20 (BSC) network to this address.</p>
            <div id="deposit-qr-code"></div>
            <div id="deposit-address">0xed5ff44a662b71023b082f5915faa49e3d386a1c</div>
            <button id="copy-deposit-addr-btn" onclick="copyDepositAddress()">Copy Address</button>
            <p style="font-size: 0.8em; color: var(--yellow-color); margin-top: 15px;">Your balance will be updated automatically after network confirmations. This may take a few minutes.</p>
        </div>
    </div>
    
    <!-- Firebase SDK -->
    <script type="module">
        // Import the functions you need from the SDKs you need
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-analytics.js";
        import { getDatabase, ref, onValue, set, update, get } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-database.js";
        
        // Your web app's Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyA7yFi1kEQD2xq51hkdpzE7ppBzpfL9UaU",
            authDomain: "pgenix-1666b.firebaseapp.com",
            databaseURL: "https://pgenix-1666b-default-rtdb.firebaseio.com",
            projectId: "pgenix-1666b",
            storageBucket: "pgenix-1666b.firebasestorage.app",
            messagingSenderId: "162586059166",
            appId: "1:162586059166:web:7d1794b1da42b63879b68f",
            measurementId: "G-1VQ22H5XC7"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const analytics = getAnalytics(app);
        const db = getDatabase(app);
        
        // Make Firebase services globally available for the main script
        window.firebaseServices = { db, ref, onValue, set, update, get };
    </script>
    
    <!-- Adexium Ads -->
    <script type="text/javascript" src="https://cdn.tgads.space/assets/js/adexium-widget.min.js"></script>
    <script type="text/javascript">
        document.addEventListener('DOMContentLoaded', () => {
            try {
                const adexiumWidget = new AdexiumWidget({wid: '591a49b2-631d-4270-ad75-bf7afd247d5f', adFormat: 'interstitial'});
                adexiumWidget.autoMode();
            } catch (e) {
                console.error("Adexium widget failed to initialize:", e);
            }
        });
    </script>

    <script>
        // --- MASTER SCRIPT ---
        let currentUserId = null; // This will hold the user's ID
        
        function showView(viewId) {
            document.querySelectorAll('.view').forEach(view => view.classList.remove('active'));
            const newView = document.getElementById(viewId);
            if(newView) newView.classList.add('active');
            
            document.querySelectorAll('.nav-bar button').forEach(button => button.classList.remove('active'));
            const navMap = {
                'tasks-section': 'tasks-section',
                'create-task-section': 'create-task-section',
                'withdrawal-section': 'withdrawal-section',
                'game-section': 'game-section',
                'invite-section': 'mining-section', 
                'mining-section': 'mining-section'
            };

            const navButtonSelector = `.nav-bar button[onclick*="'${navMap[viewId] || 'mining-section'}"]`;
            const activeBtn = document.querySelector(navButtonSelector);
            if(activeBtn) activeBtn.classList.add('active');
            
            if (viewId === 'withdrawal-section') {
                document.getElementById('withdraw-pg-balance').textContent = MiningApp.userData.pgBalance.toFixed(4);
                document.getElementById('withdraw-usdt-balance').textContent = MiningApp.userData.usdtBalance.toFixed(6);
            }
            if(viewId === 'create-task-section'){
                document.getElementById('task-usdt-balance').textContent = MiningApp.userData.usdtBalance.toFixed(2);
            }
            if(viewId === 'invite-section'){
                if (currentUserId) {
                    document.getElementById('referral-link').value = `https://t.me/YourBotName?start=${currentUserId}`; // Example Telegram link
                }
            }

            if (viewId === 'game-section') {
                if (!SnowCatcherGame.isInitialized) SnowCatcherGame.init();
                SnowCatcherGame.startGame();
            } else {
                if (SnowCatcherGame.isInitialized) SnowCatcherGame.endGame('view-switch');
            }
        }
        
        function showRandomAd(onSuccess, onError) {
            const adFunctions = [
                () => { // GigaPub
                    if (typeof window.showGiga === 'function') {
                        window.showGiga("main").then(onSuccess).catch(onError);
                    } else {
                        console.error("GigaPub SDK not available.");
                        onError("Ad provider not available.");
                    }
                },
                () => { // Monetag
                    if (typeof show_9689843 === 'function') {
                        show_9689843().then(onSuccess).catch(onError);
                    } else {
                        console.error("Monetag SDK not available.");
                        onError("Ad provider not available.");
                    }
                }
            ];
            // Show a random ad
            const randomAd = adFunctions[Math.floor(Math.random() * adFunctions.length)];
            randomAd();
        }

        function showDepositModal() {
            const depositAddress = "0xed5ff44a662b71023b082f5915faa49e3d386a1c";
            const qrCodeContainer = document.getElementById('deposit-qr-code');
            qrCodeContainer.innerHTML = '';
            const qr = qrcode(0, 'M');
            qr.addData(depositAddress);
            qr.make();
            qrCodeContainer.innerHTML = qr.createImgTag(4);
            document.getElementById('deposit-modal').style.display = 'flex';
        }
        function closeDepositModal() { document.getElementById('deposit-modal').style.display = 'none'; }
        function copyDepositAddress() {
            const address = document.getElementById('deposit-address').textContent;
            navigator.clipboard.writeText(address).then(() => alert('Address copied to clipboard!'));
        }
        function copyReferralLink() {
            const link = document.getElementById('referral-link').value;
            navigator.clipboard.writeText(link).then(() => alert('Referral link copied!'));
        }

        // --- MINING APP SCRIPT ---
        const MiningApp = {
            balanceEl: document.getElementById('balance'), statusEl: document.getElementById('status'),
            timerEl: document.getElementById('timer'), miningButton: document.getElementById('mining-button'),
            pgBalanceTopEl: document.getElementById('pg-balance-top'), usdBalanceTopEl: document.getElementById('usd-balance-top'),

            PG_PER_DAY: 0.7,
            MINING_SESSION_DURATION_MS: 6 * 60 * 60 * 1000,
            ONE_DAY_MS: 24 * 60 * 60 * 1000,
            PG_TO_USD_RATE: 0.02,
            SCORE_TO_PG_RATE: 1000,
            
            userData: {},
            miningInterval: null, timerInterval: null,

            init(userId) {
                currentUserId = userId;
                this.miningButton.addEventListener('click', () => this.handleStartMiningClick());
                document.getElementById('watch-ad-button').addEventListener('click', () => this.handleWatchAd());
                document.getElementById('back-to-mining-game').addEventListener('click', () => showView('mining-section'));
                this.loadAndListenForUserData(userId);
            },
            
            loadAndListenForUserData(userId) {
                const { db, ref, onValue, set, update } = window.firebaseServices;
                const userRef = ref(db, 'users/' + userId);

                onValue(userRef, (snapshot) => {
                    const now = new Date().getTime();
                    if (snapshot.exists()) {
                        this.userData = snapshot.val();
                        // Check for daily reset
                        if (!this.userData.lastDailyReset || (now - this.userData.lastDailyReset > this.ONE_DAY_MS)) {
                            console.log("Daily mining limit reset.");
                            update(userRef, {
                                pgMinedToday: 0,
                                lastDailyReset: now
                            }).then(() => {
                               this.userData.pgMinedToday = 0;
                               this.userData.lastDailyReset = now;
                               this.checkMiningState();
                            });
                        } else {
                           this.checkMiningState();
                        }
                    } else {
                        // Create a new user entry
                        const newUser = {
                            pgBalance: 0, usdtBalance: 0,
                            referralHP: 0, gameTokens: 0, lastGameScore: 0,
                            adsWatchedToday: 0, lastAdWatchDate: null,
                            miningSessionEndTime: null,
                            pgMinedToday: 0, lastDailyReset: now,
                            createdAt: new Date().toISOString()
                        };
                        set(userRef, newUser);
                    }
                    this.updateBalanceDisplay();
                });
            },

            checkMiningState() {
                const now = new Date().getTime();
                if (this.userData.miningSessionEndTime && now < this.userData.miningSessionEndTime) {
                    this.resumeMining();
                } else {
                    this.stopMining(true);
                }
            },
            
            handleStartMiningClick() {
                if (this.userData.pgMinedToday >= this.PG_PER_DAY) {
                    alert("Daily mining limit reached. Come back tomorrow.");
                    return;
                }
                
                this.miningButton.disabled = true;
                this.miningButton.textContent = "Loading Ad...";
                
                showRandomAd(
                    () => { // On Ad Success
                        this._beginActualMiningSession();
                    },
                    (error) => { // On Ad Error
                        alert("You must watch an ad to start mining. Please try again.");
                        console.error("Ad failed:", error);
                        this.stopMining(false); // Reset button state
                    }
                );
            },
            
            _beginActualMiningSession() {
                const { db, ref, update } = window.firebaseServices;
                const userRef = ref(db, 'users/' + currentUserId);
                const endTime = new Date().getTime() + this.MINING_SESSION_DURATION_MS;
                
                update(userRef, { miningSessionEndTime: endTime }).then(() => {
                    this.userData.miningSessionEndTime = endTime; // Update local state
                    this.resumeMining();
                });
            },

            resumeMining() {
                this.statusEl.textContent = 'Active'; this.statusEl.className = 'mining';
                this.miningButton.disabled = true; this.miningButton.textContent = 'Mining...';

                const ratePerSecond = this.PG_PER_DAY / 86400;

                clearInterval(this.miningInterval);
                this.miningInterval = setInterval(() => {
                    const { db, ref, update } = window.firebaseServices;
                    const userRef = ref(db, 'users/' + currentUserId);
                    
                    if (this.userData.pgMinedToday >= this.PG_PER_DAY) {
                       this.stopMining(true); // Stop if limit is reached during session
                       return;
                    }

                    const newPgBalance = (this.userData.pgBalance || 0) + ratePerSecond;
                    const newPgMinedToday = (this.userData.pgMinedToday || 0) + ratePerSecond;

                    // Batch update to avoid race conditions
                    update(userRef, { pgBalance: newPgBalance, pgMinedToday: newPgMinedToday });
                }, 1000);
                
                clearInterval(this.timerInterval);
                this.timerInterval = setInterval(() => this.updateTimer(), 1000);
                this.updateTimer();
            },
            
            stopMining(sessionExpired) {
                clearInterval(this.miningInterval);
                clearInterval(this.timerInterval);
                
                this.statusEl.textContent = sessionExpired ? 'Session Ended' : 'Stopped';
                this.statusEl.className = 'stopped';
                this.timerEl.textContent = 'Ready to start';
                this.miningButton.disabled = false;
                
                if ((this.userData.pgMinedToday || 0) >= this.PG_PER_DAY) {
                    this.miningButton.textContent = 'Daily Limit Reached';
                    this.miningButton.disabled = true;
                } else {
                    this.miningButton.textContent = 'Start Mining';
                }
                
                if (sessionExpired && this.userData.miningSessionEndTime) {
                    const { db, ref, update } = window.firebaseServices;
                    update(ref(db, 'users/' + currentUserId), { miningSessionEndTime: null });
                }
            },

            updateTimer() {
                const endTime = this.userData.miningSessionEndTime;
                if (!endTime) return;
                const remainingTime = endTime - new Date().getTime();
                if (remainingTime <= 0) { this.stopMining(true); return; }
                const h = Math.floor(remainingTime / 3600000);
                const m = Math.floor((remainingTime % 3600000) / 60000);
                const s = Math.floor((remainingTime % 60000) / 1000);
                this.timerEl.textContent = `Time Left: ${String(h).padStart(2, '0')}:${String(m).padStart(2, '0')}:${String(s).padStart(2, '0')}`;
            },

            updateBalanceDisplay() {
                const pgBal = this.userData.pgBalance || 0;
                const usdtBal = this.userData.usdtBalance || 0;
                this.balanceEl.textContent = `${pgBal.toFixed(4)} PG`;
                this.pgBalanceTopEl.textContent = pgBal.toFixed(4);
                this.usdBalanceTopEl.textContent = (usdtBal + (pgBal * this.PG_TO_USD_RATE)).toFixed(2);
            },
            
            updateUserData(data) {
                const { db, ref, update } = window.firebaseServices;
                update(ref(db, 'users/' + currentUserId), data);
            },

            handleWatchAd() {
                const today = new Date().toISOString().slice(0, 10);
                let adsWatched = this.userData.adsWatchedToday || 0;
                if (this.userData.lastAdWatchDate !== today) { adsWatched = 0; }
                if (adsWatched >= 15) { alert('Daily ad limit reached. Please come back tomorrow.'); return; }

                showRandomAd(
                    () => { // On Ad Success
                        adsWatched++;
                        const rand = Math.random();
                        let rewardMsg = "You watched an ad and received ";
                        let updates = { adsWatchedToday: adsWatched, lastAdWatchDate: today };

                        if (rand < 0.05) { // 5% for Game Token
                            updates.gameTokens = (this.userData.gameTokens || 0) + 1;
                            rewardMsg += "1 Game Token (RARE)!";
                        } else if (rand < 0.40) { // 35% for PG
                            const pgAmount = Math.random() * (0.2 - 0.001) + 0.001;
                            updates.pgBalance = (this.userData.pgBalance || 0) + pgAmount;
                            rewardMsg += `${pgAmount.toFixed(4)} PG Coin!`;
                        } else if (rand < 0.75) { // 35% for HP
                            updates.referralHP = (this.userData.referralHP || 0) + 2.5;
                            rewardMsg += `+${2.5} HP!`;
                        } else { // 25% for USDT
                            const usdtAmount = Math.random() * (0.002 - 0.0001) + 0.0001;
                            updates.usdtBalance = (this.userData.usdtBalance || 0) + usdtAmount;
                            rewardMsg += `${usdtAmount.toFixed(6)} USDT!`;
                        }

                        this.updateUserData(updates);
                        alert(rewardMsg + `\nAds watched today: ${adsWatched}/15`);
                    },
                    (error) => { // On Ad Error
                        alert("Failed to show ad. Please try again.");
                        console.error("Reward ad failed:", error);
                    }
                );
            }
        };

        function handleConvertClick() {
            const lastGameScore = MiningApp.userData.lastGameScore || 0;
            if (lastGameScore >= 1000) {
                const convertibleScore = Math.floor(lastGameScore / 1000) * 1000;
                const convertedPG = convertibleScore / MiningApp.SCORE_TO_PG_RATE;
                
                const newPgBalance = (MiningApp.userData.pgBalance || 0) + convertedPG;
                const newScore = lastGameScore - convertibleScore;
                
                MiningApp.updateUserData({ pgBalance: newPgBalance, lastGameScore: newScore });
                alert(`You converted ${convertibleScore} score into ${convertedPG.toFixed(4)} PG!`);
            } else { alert('You need at least 1000 score to convert.'); }
        }
        function handleWithdraw(type, method) {
            const min = type === 'pg' ? 25 : 1;
            const amount = parseFloat(document.getElementById(`${type}-withdraw-amount`).value);
            const address = document.getElementById(`${type}-withdraw-address`).value;
            const balance = type === 'pg' ? MiningApp.userData.pgBalance : MiningApp.userData.usdtBalance;

            if (!amount || isNaN(amount) || !address) { alert('Please fill in both amount and address.'); return; }
            if (amount < min) { alert(`Minimum withdrawal for ${type.toUpperCase()} is ${min}.`); return; }
            if (amount > balance) { alert('Insufficient balance.'); return; }
            
            alert(`Withdrawal request for ${amount} ${type.toUpperCase()} to ${address} via ${method} submitted. This requires backend processing.`);
        }
        
        function handleCreateTask() {
            const selectedPackage = document.querySelector('input[name="task_package"]:checked');
            if (!selectedPackage) { alert("Please select a task package."); return; }
            
            const price = parseFloat(selectedPackage.value);
            if (MiningApp.userData.usdtBalance >= price) {
                const newBalance = MiningApp.userData.usdtBalance - price;
                MiningApp.updateUserData({ usdtBalance: newBalance });
                alert(`Task created successfully for $${price}! It is now under review.`);
                showView('mining-section');
            } else {
                alert("Insufficient USDT balance. Please deposit or earn more.");
            }
        }

        // --- SNOW CATCHER GAME SCRIPT (Unchanged) ---
        const SnowCatcherGame = {
            isInitialized: false, score: 0, missed: 0, usdtScore: 0.0, timeRemaining: 60, baseSpeed: 1.0, isGameOver: true,
            init() {
                if(this.isInitialized) return;
                Object.assign(this, {
                    gameContainer: document.querySelector('#game-section #game-container'), scoreSpan: document.querySelector('#game-section #score'),
                    missedSpan: document.querySelector('#game-section #missed'), usdtScoreSpan: document.querySelector('#game-section #usdt-score'),
                    timerSpan: document.querySelector('#game-section #timer-value'), gameOverDiv: document.querySelector('#game-section #game-over'),
                    gameOverTitle: document.querySelector('#game-section #game-over-title'), finalScoreSpan: document.querySelector('#game-section #final-score'),
                    finalUsdtScoreSpan: document.querySelector('#game-section #final-usdt-score'), restartButton: document.querySelector('#game-section #restart-button')
                });
                this.gameContainer.addEventListener('pointerdown', (e) => { if (e.target.matches('.falling-object')) this.handleObjectClick(e.target); });
                this.restartButton.addEventListener('click', () => this.startGame()); this.isInitialized = true;
            },
            createFallingObject() { if (this.isGameOver) return; const r = Math.random(); this.createObject(r < 0.08 ? 'üí£' : (r < 0.15 ? 'üí∏' : '‚ùÑÔ∏è'), r < 0.08 ? 'bomb' : (r < 0.15 ? 'coin' : 'snowflake')); },
            createObject(emoji, type) {
                const obj = document.createElement('div'); obj.className = 'falling-object'; obj.classList.add(type); obj.innerHTML = emoji;
                obj.dataset.type = type; obj.style.left = Math.random() * (this.gameContainer.offsetWidth - 70) + 'px';
                obj.style.top = '-50px'; obj.style.fontSize = (Math.random() * 12 + 24) + 'px';
                obj.dataset.speed = Math.random() * 1.5 + this.baseSpeed; obj.dataset.sway = (Math.random() - 0.5) * 2;
                obj.dataset.swayAngle = Math.random() * Math.PI * 2;
                if (type === 'coin') obj.dataset.value = Math.random() * (0.001 - 0.0001) + 0.0001;
                this.gameContainer.appendChild(obj);
            },
            handleObjectClick(obj) {
                if (this.isGameOver || obj.classList.contains('collected')) return; const type = obj.dataset.type;
                if (type === 'snowflake') { this.score++; this.scoreSpan.textContent = this.score; this.animateAndRemove(obj); } 
                else if (type === 'coin') { this.usdtScore += parseFloat(obj.dataset.value); this.usdtScoreSpan.textContent = this.usdtScore.toFixed(6); this.animateAndRemove(obj); } 
                else if (type === 'bomb') this.endGame('bomb');
            },
            animateAndRemove(obj) { obj.classList.add('collected'); setTimeout(() => { obj.remove(); }, 300); },
            gameLoop() {
                document.querySelectorAll('#game-section .falling-object:not(.collected)').forEach(obj => {
                    let top = parseFloat(obj.style.top) + parseFloat(obj.dataset.speed), left = parseFloat(obj.style.left) + Math.sin(parseFloat(obj.dataset.swayAngle)) * parseFloat(obj.dataset.sway);
                    if (left < 0) left = 0; if (left > this.gameContainer.offsetWidth - obj.offsetWidth) left = this.gameContainer.offsetWidth - obj.offsetWidth;
                    obj.style.top = top + 'px'; obj.style.left = left + 'px'; obj.dataset.swayAngle = parseFloat(obj.dataset.swayAngle) + 0.05;
                    if (top > this.gameContainer.offsetHeight) { if (obj.classList.contains('snowflake')) { this.missed++; this.missedSpan.textContent = this.missed; } obj.remove(); }
                });
            },
            setCreationInterval(ms) { clearInterval(this.objectCreationInterval); this.objectCreationInterval = setInterval(() => this.createFallingObject(), ms); },
            startGame() {
                this.isGameOver = false; this.score = 0; this.missed = 0; this.usdtScore = 0.0; this.timeRemaining = 60; this.baseSpeed = 1.0;
                this.scoreSpan.textContent = this.score; this.missedSpan.textContent = this.missed; this.usdtScoreSpan.textContent = this.usdtScore.toFixed(6);
                this.timerSpan.textContent = this.timeRemaining; this.gameOverDiv.style.display = 'none'; this.gameContainer.style.cursor = 'crosshair';
                document.querySelectorAll('#game-section .falling-object').forEach(el => el.remove()); this.clearAllIntervals();
                this.gameLoopInterval = setInterval(() => this.gameLoop(), 16); this.setCreationInterval(800); this.gameTimer = setTimeout(() => this.endGame('time'), 60000);
                this.countdownInterval = setInterval(() => {
                    this.timeRemaining--; this.timerSpan.textContent = this.timeRemaining; this.baseSpeed += 0.05;
                    if (this.timeRemaining === 45) this.setCreationInterval(600); else if (this.timeRemaining === 30) this.setCreationInterval(400); else if (this.timeRemaining === 15) this.setCreationInterval(250);
                }, 1000);
            },
            clearAllIntervals() { clearInterval(this.gameLoopInterval); clearInterval(this.objectCreationInterval); clearInterval(this.countdownInterval); clearTimeout(this.gameTimer); },
            endGame(reason) {
                if (this.isGameOver) return; this.isGameOver = true; this.clearAllIntervals();
                if (reason === 'view-switch') return;

                if (reason === 'bomb') {
                    this.gameOverTitle.textContent = "You hit a bomb!"; this.gameOverTitle.style.color = "var(--red-glow)";
                    this.finalScoreSpan.textContent = "0 (Void)"; this.finalUsdtScoreSpan.textContent = "0.000000 (Void)";
                } else { // Time's up
                    this.gameOverTitle.textContent = "Time's Up!"; this.gameOverTitle.style.color = "var(--primary-color)";
                    this.finalScoreSpan.textContent = this.score; this.finalUsdtScoreSpan.textContent = this.usdtScore.toFixed(6);
                    
                    const newLastGameScore = (MiningApp.userData.lastGameScore || 0) + this.score;
                    const newUsdtBalance = (MiningApp.userData.usdtBalance || 0) + this.usdtScore;
                    let updates = { lastGameScore: newLastGameScore };
                    if (this.usdtScore > 0) {
                        updates.usdtBalance = newUsdtBalance;
                        alert(`${this.usdtScore.toFixed(6)} USDT has been added to your balance!`);
                    }
                    MiningApp.updateUserData(updates);
                }
                this.gameOverDiv.style.display = 'block'; this.gameContainer.style.cursor = 'default';
            }
        };

        // --- App Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
            if (window.firebaseServices) {
                const tg = window.Telegram.WebApp;
                tg.ready();
                tg.expand();

                let userId;
                if (tg.initDataUnsafe && tg.initDataUnsafe.user && tg.initDataUnsafe.user.id) {
                    userId = "tg_user_" + tg.initDataUnsafe.user.id;
                    console.log("Telegram user identified:", userId);
                } else {
                    userId = "web_user_test_abc_123"; // Fallback for testing in browser
                    console.warn("Telegram user not found. Using fallback ID:", userId);
                }
                
                MiningApp.init(userId);
                showView('mining-section');
            } else {
                console.error("Firebase services not available.");
                alert("Error: Could not connect to the database. Please refresh.");
            }
        });
    </script>
</body>
</html>