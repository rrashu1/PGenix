<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0">
    <title>PG Coin Mining & Games</title>
    <style>
        /* --- Global Styles & Fonts --- */
        @import url('https://fonts.googleapis.com/css2?family=Hind+Siliguri:wght@400;600;700&display=swap');

        :root {
            --primary-color: #00e5ff;
            --secondary-color: #7b2cbf;
            --background-color: #0d0c22;
            --surface-color: #191835;
            --text-color: #e0e0e0;
            --glow-color: rgba(0, 229, 255, 0.7);
            --green-glow: #00ff7f;
            --red-glow: #ff4d4d;
            --orange-color: #e67e22;
            --yellow-color: #f1c40f;
        }

        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
            overflow: hidden;
        }

        body {
            font-family: 'Hind Siliguri', sans-serif;
            background-color: var(--background-color);
            color: var(--text-color);
            display: flex;
            justify-content: center;
            touch-action: none;
        }

        #app-wrapper {
            width: 100%;
            height: 100%;
            max-width: 420px;
            position: relative;
            display: flex;
            flex-direction: column;
            background: var(--background-color);
        }

        /* --- View Management --- */
        .view-container {
            flex-grow: 1;
            overflow-y: auto;
            -ms-overflow-style: none;
            scrollbar-width: none;
            position: relative;
        }
        .view-container::-webkit-scrollbar { display: none; }

        .view {
            display: none;
            width: 100%;
            min-height: 100%;
            position: absolute;
            top: 0; left: 0;
            animation: fadeIn 0.5s ease-in-out;
            flex-direction: column;
            justify-content: flex-start;
            align-items: center;
            box-sizing: border-box;
            padding: 25px;
        }
        .view.active { display: flex; }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.98); }
            to { opacity: 1; transform: scale(1); }
        }

        /* --- Common Page Styles --- */
        .page-header {
            display: flex; align-items: center; justify-content: center;
            position: relative; margin-bottom: 20px; width: 100%;
        }
        .back-button {
            position: absolute; left: 0; background: var(--surface-color);
            border: 1px solid var(--secondary-color); color: var(--primary-color);
            width: 40px; height: 40px; border-radius: 50%;
            font-size: 24px; cursor: pointer; display: flex;
            align-items: center; justify-content: center;
        }
        .page-title {
            color: var(--primary-color); font-size: 1.8em;
            text-shadow: 0 0 10px var(--glow-color); margin: 0;
        }

        /* --- Mining App Styles --- */
         #mining-section {
             padding: 0; 
        }
        #mining-section .container {
            width: 100%;
            height: 100%;
            background: linear-gradient(145deg, var(--surface-color), #211f42);
            padding: 25px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
            text-align: center;
            display: flex; flex-direction: column;
            justify-content: space-between;
            border: 2px solid var(--secondary-color);
            box-sizing: border-box;
        }
        #top-balance-bar {
            background: rgba(0, 0, 0, 0.3); padding: 10px 15px; border-radius: 12px;
            margin-bottom: 15px; display: flex; justify-content: space-between;
            align-items: center; border: 1px solid var(--secondary-color);
        }
        #top-balance-bar div { font-size: 1.1em; font-weight: 600; }
        #top-balance-bar #pg-balance-top { color: var(--primary-color); }
        #top-balance-bar #usd-balance-top { color: var(--green-glow); }
        .header-icons { display: flex; align-items: center; gap: 15px; }
        .header-icon-btn { background: none; border: none; color: var(--text-color); cursor: pointer; position: relative; }
        .header-icon-btn svg { width: 28px; height: 28px; }
        .unread-dot {
            position: absolute; top: 0; right: 0; width: 10px; height: 10px;
            background-color: var(--red-glow); border-radius: 50%; border: 1px solid white;
            display: none;
        }


        #mining-section h1 { color: var(--primary-color); margin-bottom: 10px; font-size: 2.2em; text-shadow: 0 0 10px var(--glow-color); }
        .mining-display {
            background-color: rgba(0,0,0,0.2); padding: 20px; border-radius: 20px;
            margin-bottom: 15px; border: 1px solid var(--secondary-color);
            box-shadow: inset 0 0 15px rgba(0,0,0,0.3);
        }
        #balance { font-size: 2.5em; font-weight: 700; color: var(--primary-color); text-shadow: 0 0 8px var(--glow-color); word-wrap: break-word; margin-bottom: 15px; }
        
        #status-container { font-size: 1.2em; margin-bottom: 10px; }
        #status.mining { color: var(--green-glow); font-weight: 600; animation: glow-green 1.5s infinite alternate; }
        #status.stopped { color: var(--red-glow); font-weight: 600; }
        @keyframes glow-green {
            from { text-shadow: 0 0 5px var(--green-glow), 0 0 10px var(--green-glow); }
            to { text-shadow: 0 0 15px var(--green-glow), 0 0 20px var(--green-glow); }
        }
        #timer { font-size: 1.3em; font-weight: 600; color: #ccc; min-height: 25px; }
        
        .button-row { display: flex; gap: 10px; width: 100%; margin-bottom: 15px; }
        #mining-button, #watch-ad-button {
            flex: 1; padding: 15px 10px; font-size: 1.1em; font-weight: 700;
            font-family: 'Hind Siliguri', sans-serif; border: none; border-radius: 12px;
            cursor: pointer; transition: all 0.3s ease; box-sizing: border-box;
            display: flex; align-items: center; justify-content: center; gap: 8px;
        }
        #mining-button {
            background: linear-gradient(45deg, var(--primary-color), var(--secondary-color));
            color: var(--background-color); box-shadow: 0 5px 20px rgba(123, 44, 191, 0.4);
        }
        #mining-button:hover { transform: translateY(-3px); box-shadow: 0 8px 25px rgba(0, 229, 255, 0.5); }
        #mining-button:disabled { background: #555; color: #999; cursor: not-allowed; box-shadow: none; transform: none; }
        
        #watch-ad-button {
             background: linear-gradient(45deg, var(--yellow-color), var(--orange-color));
             color: var(--background-color);
        }
        #watch-ad-button svg { width: 20px; height: 20px; }
        
        .nav-bar {
            width: 100%; max-width: 420px;
            display: flex; justify-content: space-around; align-items: center; background: rgba(0,0,0,0.5);
            padding: 10px 5px; border-top: 1px solid var(--secondary-color);
            backdrop-filter: blur(5px); box-sizing: border-box; flex-shrink: 0;
        }
        .nav-bar button {
            background: transparent; border: none; color: var(--text-color); cursor: pointer;
            text-align: center; font-size: 0.8em; display: flex; flex-direction: column;
            align-items: center; gap: 5px; transition: color 0.2s; flex: 1;
        }
        .nav-bar button:hover, .nav-bar button.active { color: var(--primary-color); }
        .nav-bar svg { width: 28px; height: 28px; }
        
        /* --- Invite Section --- */
        #invite-section .invite-box { background: var(--surface-color); padding: 25px; border-radius: 15px; border: 1px solid var(--secondary-color); width:100%; }
        #invite-section h3 { margin-top: 0; color: var(--primary-color); }
        #invite-section p { color: #ccc; }
        #invite-section .referral-link-container { display: flex; margin-top: 20px; }
        #invite-section #referral-link { flex-grow: 1; background: var(--background-color); border: 1px solid var(--secondary-color); border-radius: 8px 0 0 8px; padding: 12px; color: white; }
        #invite-section #copy-ref-btn { background: var(--primary-color); color: var(--background-color); border: none; padding: 0 15px; border-radius: 0 8px 8px 0; font-weight: bold; cursor: pointer; }

        /* --- Profile Section --- */
        #profile-section .profile-card {
            background: var(--surface-color); border-radius: 15px; padding: 20px; width: 100%;
            border: 1px solid var(--secondary-color); text-align: left;
        }
        #profile-section h3 { color: var(--primary-color); }
        #profile-section .stat-row { display: flex; justify-content: space-between; margin: 10px 0; font-size: 1.1em; }
        #profile-section .stat-label { color: #ccc; }
        #profile-section .stat-value { font-weight: bold; color: var(--primary-color); }
        
        .level-card { margin-top: 20px; background: rgba(0,0,0,0.2); padding: 15px; border-radius: 10px; }
        .level-display { display: flex; justify-content: space-between; align-items: center; font-size: 1.3em; margin-bottom: 15px; }
        .level-display span { font-weight: bold; }
        .level-display .current-level { color: var(--yellow-color); }
        .progress-bar { width: 100%; background: var(--background-color); border-radius: 5px; height: 10px; overflow: hidden; margin-bottom: 5px; }
        .progress-bar-inner { height: 100%; background: var(--green-glow); width: 0%; transition: width 0.5s; }
        .progress-label { font-size: 0.9em; color: #aaa; text-align: right; }
        .level-requirements ul { list-style: none; padding: 0; text-align: left; margin-top: 15px; }
        .level-requirements li { margin-bottom: 8px; color: #ccc; }
        .level-requirements li.completed { color: var(--green-glow); text-decoration: line-through; }
        
        /* --- Inbox Section --- */
        #inbox-section .message-list { width: 100%; display: flex; flex-direction: column; gap: 15px; }
        .message-card { background: var(--surface-color); border-radius: 10px; padding: 15px; text-align: left; border-left: 4px solid var(--secondary-color); cursor: pointer; }
        .message-card.unread { border-left-color: var(--primary-color); }
        .message-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .message-title { font-weight: bold; color: var(--primary-color); }
        .message-date { font-size: 0.8em; color: #aaa; }
        .message-body { color: #ccc; }
        .no-data { text-align: center; color: #888; margin-top: 40px; }
        
        /* --- Game Section --- */
        #game-section h1 { color: var(--primary-color); text-shadow: 2px 2px 4px #000; margin-bottom:15px; }
        #game-start-screen { display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; background: rgba(0,0,0,0.7); padding: 30px; border-radius: 15px; width:100%; }
        #game-token-count { font-size: 1.2em; margin-bottom: 20px; }
        #game-token-count span { color: var(--yellow-color); font-weight: bold; }
        #start-game-btn { padding: 15px 30px; font-size: 1.5em; background: var(--green-glow); color: var(--background-color); border-radius: 10px; cursor: pointer; font-weight: bold; }
        #start-game-btn:disabled { background: #555; cursor: not-allowed; }
        #game-container { position: relative; width: 90vw; max-width: 400px; height: 60vh; background: #001f3f; border: 3px solid var(--secondary-color); border-radius: 10px; overflow: hidden; cursor: crosshair; display: none; }
        .falling-object { position: absolute; font-size: 28px; user-select: none; cursor: pointer; transition: transform 0.1s ease-out; padding: 12px; text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.5); }
        .falling-object.collected { animation: collect-effect 0.3s ease-out forwards; pointer-events: none; }
        @keyframes collect-effect { 0% { transform: scale(1); opacity: 1; } 100% { transform: scale(1.5); opacity: 0; } }
        #scoreboard { margin-bottom: 15px; font-size: 1.2em; background-color: rgba(0, 0, 0, 0.3); padding: 10px 20px; border-radius: 8px; color: white; border: 1px solid var(--secondary-color); }
        #game-over { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(0, 0, 0, 0.85); padding: 30px; border-radius: 15px; text-align: center; display: none; z-index: 10; width: 80%; border: 1px solid var(--primary-color); }

        /* --- Withdrawal Section --- */
        #withdrawal-section .withdrawal-form {
            background: var(--surface-color); padding: 20px; border-radius: 15px; width: 100%;
            border: 1px solid var(--secondary-color); margin-bottom: 25px;
        }
        #withdrawal-section h3 { color: var(--primary-color); margin-top: 0; }
        #withdrawal-section p { color: #ccc; font-size: 0.9em; }
        #withdrawal-section input {
            width: 100%; background: var(--background-color); border: 1px solid var(--secondary-color);
            border-radius: 8px; padding: 12px; color: white; font-size: 1em;
            margin-bottom: 15px; box-sizing: border-box;
        }
        .withdraw-btn-group { display: flex; gap: 10px; }
        .withdraw-btn {
            flex: 1; padding: 12px; border: none; border-radius: 8px; font-weight: bold;
            font-size: 1em; cursor: pointer;
        }
        .withdraw-btn.bkash { background-color: #e2136e; color: white; }
        .withdraw-btn.binance { background-color: #f0b90b; color: #1e2329; }
        
        /* --- Unchanged Sections: Tasks & Advertise --- */
        #tasks-section .task-placeholder { margin-top: 50px; font-size: 1.3em; color: #aaa; }
        #create-task-section .balance-info { font-size: 1.2em; margin-bottom: 20px; background: rgba(0,0,0,0.2); padding: 10px; border-radius: 10px; }
        #create-task-section .balance-info strong { color: var(--green-glow); }
        #create-task-section .task-package-grid { display: grid; grid-template-columns: 1fr; gap: 15px; width: 100%; margin-bottom: 20px; }
        .task-package-card { background: linear-gradient(145deg, var(--surface-color), #211f42); border: 2px solid var(--secondary-color); border-radius: 15px; padding: 15px; text-align: left; cursor: pointer; position: relative; }
        .task-package-card:has(input:checked) { border-color: var(--primary-color); box-shadow: 0 0 15px var(--glow-color); }
        .task-package-card input[type="radio"] { position: absolute; opacity: 0; }
        .task-package-card h3 { color: var(--primary-color); margin: 0 0 10px 0; }
        .task-package-card p { margin: 0; color: var(--text-color); font-size: 1.1em; }
        .task-package-card p strong { color: var(--yellow-color); }
        #create-task-btn, #deposit-usdt-btn { width: 100%; padding: 15px; font-size: 1.3em; font-weight: 700; color: var(--background-color); border: none; border-radius: 10px; cursor: pointer; margin-top: 10px; }
        #create-task-btn { background: linear-gradient(45deg, var(--green-glow), var(--primary-color)); }
        #deposit-usdt-btn { background: linear-gradient(45deg, var(--yellow-color), var(--orange-color)); }
        
    </style>
    <!-- Dependencies -->
    <script src="https://cdn.jsdelivr.net/npm/qrcode-generator/qrcode.js"></script>
    <script src="https://telegram.org/js/web-app.js"></script>
    <script src="https://ad.gigapub.tech/script?id=1470"></script>
    <script src='//libtl.com/sdk.js' data-zone='9689843' data-sdk='show_9689843'></script>
</head>
<body>
    <div id="app-wrapper">
        <div class="view-container">
            <!-- Mining App View -->
            <div id="mining-section" class="view active">
                 <div class="container">
                    <div>
                        <div id="top-balance-bar">
                            <div class="header-icons">
                                <button class="header-icon-btn" onclick="showView('profile-section')">
                                    <svg fill="currentColor" viewBox="0 0 24 24"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg>
                                </button>
                                <button class="header-icon-btn" onclick="showView('inbox-section')">
                                     <svg fill="currentColor" viewBox="0 0 24 24"><path d="M20 4H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 4l-8 5-8-5V6l8 5 8-5v2z"/></svg>
                                     <div id="unread-dot" class="unread-dot"></div>
                                </button>
                            </div>
                            <div>PG <span id="pg-balance-top">0.0000</span></div>
                            <div>$ <span id="usd-balance-top">0.00</span></div>
                        </div>
                        <h1>PG Coin Mining</h1>
                        <div class="mining-display">
                            <h2>Your Balance</h2>
                            <p id="balance">0.0000 PG</p>
                             <p id="status-container">Status: <span id="status" class="stopped">Stopped</span></p>
                            <p id="timer"></p>
                        </div>
                        <div class="button-row">
                           <button id="mining-button">Start Mining</button>
                           <button id="watch-ad-button" onclick="MiningApp.handleWatchAd()">
                                <svg fill="currentColor" viewBox="0 0 24 24"><path d="M21.406 8.442a2.368 2.368 0 0 0-1.666-1.696C18.15 6.25 12 6.25 12 6.25s-6.15 0-7.74.496a2.368 2.368 0 0 0-1.666 1.696C2.1 10.046 2.1 12 2.1 12s0 1.954.494 3.558a2.368 2.368 0 0 0 1.666 1.696c1.59.496 7.74.496 7.74.496s6.15 0 7.74-.496a2.368 2.368 0 0 0 1.666-1.696C21.9 13.954 21.9 12 21.9 12s0-1.954-.494-3.558zM9.9 14.5v-5l4.5 2.5-4.5 2.5z"/></svg>
                                <span>Daily Claim Rewards</span>
                           </button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Invite View -->
            <div id="invite-section" class="view">
                 <div class="page-header">
                    <button class="back-button" onclick="showView('mining-section')">‹</button>
                    <h2 class="page-title">Invite Friends</h2>
                </div>
                <div class="invite-box">
                    <h3>Share Your Link</h3>
                    <p>Invite friends to get 1 Game Token and 2.5 HP (30 days) for each referral!</p>
                    <div class="referral-link-container">
                        <input type="text" id="referral-link" readonly value="Loading...">
                        <button id="copy-ref-btn" onclick="copyReferralLink()">Copy</button>
                    </div>
                </div>
            </div>

            <!-- Profile View -->
            <div id="profile-section" class="view">
                <div class="page-header">
                    <button class="back-button" onclick="showView('mining-section')">‹</button>
                    <h2 class="page-title">My Profile</h2>
                </div>
                <div class="profile-card">
                    <h3>Lifetime Stats</h3>
                    <div class="stat-row">
                        <span class="stat-label">Total PG Earned</span>
                        <span id="lifetime-pg" class="stat-value">0.0000</span>
                    </div>
                    <div class="stat-row">
                        <span class="stat-label">Total USDT Earned</span>
                        <span id="lifetime-usdt" class="stat-value">0.00</span>
                    </div>

                    <div class="level-card">
                        <div class="level-display">
                            <span>Level <span id="current-level" class="current-level">1</span></span>
                            <span id="next-level-label">To Level 2</span>
                        </div>
                        <div class="progress-bar">
                            <div id="level-progress-bar" class="progress-bar-inner"></div>
                        </div>
                        <div id="progress-label" class="progress-label">0/3</div>
                        
                        <div class="level-requirements">
                            <h4>Requirements:</h4>
                            <ul id="level-req-list"></ul>
                        </div>
                    </div>
                </div>
            </div>
            
             <!-- Inbox View -->
            <div id="inbox-section" class="view">
                <div class="page-header">
                    <button class="back-button" onclick="showView('mining-section')">‹</button>
                    <h2 class="page-title">Inbox</h2>
                </div>
                <div id="inbox-list" class="message-list">
                    <div class="no-data">No messages yet.</div>
                </div>
            </div>

            <!-- Game View -->
            <div id="game-section" class="view">
                <div id="game-start-screen">
                    <h1>Snow & Coin Catcher</h1>
                    <p id="game-token-count">You have <span>0</span> Game Tokens.</p>
                    <button id="start-game-btn">Start Game (1 Token)</button>
                    <button class="back-button" style="position: static; margin-top: 20px;" onclick="showView('mining-section')">Go Back</button>
                </div>

                <div id="game-container">
                    <div id="scoreboard">
                        <span>Score: </span><span id="score">0</span> | 
                        <span>USDT: </span><span id="usdt-score">0.000000</span> |
                        <span>Time: </span><span id="timer-value">60</span>s
                    </div>
                     <div id="game-over">
                        <h2>Game Over!</h2>
                        <p>Final Score: <span id="final-score">0</span></p>
                        <p>Total USDT: <span id="final-usdt-score">0.000000</span></p>
                        <button id="restart-button">Play Again (1 Token)</button>
                    </div>
                </div>
            </div>
            
            <!-- Withdrawal View -->
             <div id="withdrawal-section" class="view">
                <div class="page-header">
                    <button class="back-button" onclick="showView('mining-section')">‹</button>
                    <h2 class="page-title">Withdrawal</h2>
                </div>
                <div class="withdrawal-form">
                    <h3>Withdraw PG Coin</h3>
                    <p>Available: <span id="withdraw-pg-balance">0.0000</span> PG</p>
                    <input type="number" id="pg-withdraw-amount" placeholder="Amount (e.g., 25)">
                    <input type="text" id="pg-withdraw-address" placeholder="bKash Number or Binance UID">
                    <div class="withdraw-btn-group">
                        <button class="withdraw-btn bkash" onclick="handleWithdraw('pg', 'bkash')">bKash</button>
                        <button class="withdraw-btn binance" onclick="handleWithdraw('pg', 'binance')">Binance</button>
                    </div>
                </div>
                 <div class="withdrawal-form">
                    <h3>Withdraw USDT</h3>
                    <p>Available: <span id="withdraw-usdt-balance">0.000000</span> USDT</p>
                    <input type="number" id="usdt-withdraw-amount" placeholder="Amount (e.g., 1.5)">
                    <input type="text" id="usdt-withdraw-address" placeholder="bKash Number or Binance UID">
                    <div class="withdraw-btn-group">
                        <button class="withdraw-btn bkash" onclick="handleWithdraw('usdt', 'bkash')">bKash</button>
                        <button class="withdraw-btn binance" onclick="handleWithdraw('usdt', 'binance')">Binance</button>
                    </div>
                </div>
             </div>

            <!-- Unchanged Views: Tasks & Advertise -->
            <div id="tasks-section" class="view">
                <div class="page-header">
                    <button class="back-button" onclick="showView('mining-section')">‹</button>
                    <h2 class="page-title">Available Tasks</h2>
                </div>
                <p class="task-placeholder">New tasks from advertisers will appear here!</p>
            </div>
            <div id="create-task-section" class="view">
                 <div class="page-header">
                    <button class="back-button" onclick="showView('mining-section')">‹</button>
                    <h2 class="page-title">Create a Task</h2>
                </div>
                <div class="balance-info" style="width:100%">Your USDT Balance: <strong id="task-usdt-balance">0.00</strong></div>
                <div id="task-package-form" style="width:100%">
                    <div class="task-package-grid">
                        <label class="task-package-card"><input type="radio" name="task_package" value="0.5"><h3>500 Tasks</h3><p>Price: <strong>$0.50</strong></p></label>
                        <label class="task-package-card"><input type="radio" name="task_package" value="0.9"><h3>1,000 Tasks</h3><p>Price: <strong>$0.90</strong></p></label>
                    </div>
                    <button id="create-task-btn" onclick="alert('This feature is for advertisers.')">Create Task</button>
                    <button id="deposit-usdt-btn" onclick="alert('This feature is for advertisers.')">Deposit USDT</button>
                </div>
            </div>
        </div>

        <div class="nav-bar">
             <button onclick="showView('mining-section')" class="active"><svg fill="currentColor" viewBox="0 0 24 24"><path d="M12.71 2.29a1 1 0 0 0-1.42 0l-9 9a1 1 0 0 0 0 1.42A1 1 0 0 0 3 13h1v7a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-7h1a1 1 0 0 0 .71-1.71zM18 20H6v-9.59l6-6 6 6z"/></svg><span>Home</span></button>
             <button onclick="showView('invite-section')"><svg fill="currentColor" viewBox="0 0 24 24"><path d="M16 11c1.66 0 2.99-1.34 2.99-3S17.66 5 16 5c-1.66 0-3 1.34-3 3s1.34 3 3 3zm-8 0c1.66 0 2.99-1.34 2.99-3S9.66 5 8 5C6.34 5 5 6.34 5 8s1.34 3 3 3zm0 2c-2.33 0-7 1.17-7 3.5V19h14v-2.5c0-2.33-4.67-3.5-7-3.5zm8 0c-.29 0-.62.02-.97.05 1.16.84 1.97 1.97 1.97 3.45V19h6v-2.5c0-2.33-4.67-3.5-7-3.5z"/></svg><span>Invite</span></button>
             <button onclick="showView('tasks-section')"><svg fill="currentColor" viewBox="0 0 24 24"><path d="M15.54 10.5h-1a.5.5 0 0 1 0-1h1a.5.5 0 0 1 0 1zm-5.08 0H7.2a.5.5 0 0 1 0-1h3.26a.5.5 0 0 1 0 1zm5.08 4h-1a.5.5 0 0 1 0-1h1a.5.5 0 0 1 0 1zm-5.08 0H7.2a.5.5 0 0 1 0-1h3.26a.5.5 0 0 1 0 1zM21 4H3a1 1 0 0 0-1 1v14a1 1 0 0 0 1 1h18a1 1 0 0 0 1-1V5a1 1 0 0 0-1-1zm-1 14H4V6h16z"/></svg><span>Tasks</span></button>
             <button onclick="showView('create-task-section')"><svg fill="currentColor" viewBox="0 0 24 24"><path d="M20.29 4.29l-1.58 1.58C19.8 6.45 20 7.21 20 8s-.2 1.55-.58 2.13l1.58 1.58c.87-1.12 1-2.67 1-4.71s-.13-3.59-1-4.71zM4 8c0-.79.2-1.55.59-2.13L2.71 4.29C1.83 5.41 1.71 6.96 1.71 9s.13 3.59 1 4.71l1.88-1.88C4.2 11.27 4 10.53 4 9.79V8zm12-2h-4v4h4V6zM12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8z"/></svg><span>Advertise</span></button>
             <button onclick="showView('withdrawal-section')"><svg fill="currentColor" viewBox="0 0 24 24"><path d="M5 20a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V8h2V6h-4V4a2 2 0 0 0-2-2H9a2 2 0 0 0-2 2v2H3v2h2v12zM9 4h6v2H9V4zm10 6H5v10h14V10z"></path><path d="M11 12h2v6h-2z"/></svg><span>Withdraw</span></button>
             <button onclick="showView('game-section')"><svg fill="currentColor" viewBox="0 0 24 24"><path d="M3.5 11c.41 0 .79-.13 1.11-.34a.5.5 0 0 1 .45.89 2.49 2.49 0 0 1-3.12 0 .5.5 0 0 1 .45-.89A1.49 1.49 0 0 1 3.5 11zm17 0a1.49 1.49 0 0 1 1.11.34.5.5 0 0 1 .45-.89 2.49 2.49 0 0 1-3.12 0 .5.5 0 0 1 .45.89A1.49 1.49 0 0 1 20.5 11zM12 4.5a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-1 0v-1a.5.5 0 0 1 .5-.5zM6.27 6.27a.5.5 0 0 1 .71 0l.7.7a.5.5 0 0 1-.7.71l-.71-.7a.5.5 0 0 1 0-.71zm11.46 0a.5.5 0 0 1 .71.71l-.7.7a.5.5 0 0 1-.71-.7l.7-.7a.5.5 0 0 1 .01 0zM12 13a3 3 0 1 1 3-3 3 3 0 0 1-3 3zm0-5a2 2 0 1 0 2 2 2 2 0 0 0-2-2zm-1 12.5a.5.5 0 0 1 .5-.5h1a.5.5 0 0 1 0 1h-1a.5.5 0 0 1-.5-.5zM12 22a7 7 0 0 1-7-7 .5.5 0 0 1 1 0 6 6 0 0 0 12 0 .5.5 0 0 1 1 0 7 7 0 0 1-7 7z"/></svg><span>Game</span></button>
        </div>
    </div>
    
    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-analytics.js";
        import { getDatabase, ref, onValue, set, update, get, push } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-database.js";
        
        const firebaseConfig = {
            apiKey: "AIzaSyA7yFi1kEQD2xq51hkdpzE7ppBzpfL9UaU",
            authDomain: "pgenix-1666b.firebaseapp.com",
            databaseURL: "https://pgenix-1666b-default-rtdb.firebaseio.com",
            projectId: "pgenix-1666b",
            storageBucket: "pgenix-1666b.firebasestorage.app",
            messagingSenderId: "162586059166",
            appId: "1:162586059166:web:7d1794b1da42b63879b68f",
            measurementId: "G-1VQ22H5XC7"
        };

        const app = initializeApp(firebaseConfig);
        const analytics = getAnalytics(app);
        const db = getDatabase(app);
        
        window.firebaseServices = { db, ref, onValue, set, update, get, push, analytics };
    </script>
    
    <!-- Adexium Ads -->
    <script type="text/javascript" src="https://cdn.tgads.space/assets/js/adexium-widget.min.js"></script>
    
    <script>
        // --- GLOBAL & UTILITY ---
        let currentUserId = null;
        
        function showView(viewId) {
            document.querySelectorAll('.view').forEach(view => view.classList.remove('active'));
            document.getElementById(viewId)?.classList.add('active');
            
            document.querySelectorAll('.nav-bar button').forEach(button => button.classList.remove('active'));
            const navMap = {
                'invite-section': 'invite-section', // Made invite its own nav item
                'tasks-section': 'tasks-section',
                'create-task-section': 'create-task-section',
                'withdrawal-section': 'withdrawal-section',
                'game-section': 'game-section',
                'mining-section': 'mining-section',
                'profile-section': 'mining-section',
                'inbox-section': 'mining-section'
            };
            // Remap nav buttons to sections they lead to
            const navButton = document.querySelector(`.nav-bar button[onclick*="'${navMap[viewId] || 'mining-section'}"]`);
            if (navButton) navButton.classList.add('active');

            if (viewId === 'profile-section') ProfileApp.render(MiningApp.userData);
            if (viewId === 'inbox-section') InboxApp.render(MiningApp.userData.messages, MiningApp.userData.readMessages);
            if (viewId === 'game-section') GameApp.showStartScreen();
        }

        function showRandomAd(onSuccess, onError) {
            const adFunctions = [
                () => window.showGiga ? window.showGiga().then(onSuccess).catch(onError) : onError("GigaPub not ready"),
                () => window.show_9689843 ? show_9689843().then(onSuccess).catch(onError) : onError("Monetag not ready")
            ];
            adFunctions[Math.floor(Math.random() * adFunctions.length)]();
        }

        function copyReferralLink() {
            const link = document.getElementById('referral-link').value;
            navigator.clipboard.writeText(link).then(() => alert('Referral link copied!'));
        }

        function handleWithdraw(type, method) {
            const { db, ref, push, update } = window.firebaseServices;
            const amountEl = document.getElementById(`${type}-withdraw-amount`);
            const addressEl = document.getElementById(`${type}-withdraw-address`);
            const amount = parseFloat(amountEl.value);
            const address = addressEl.value.trim();
            const balanceKey = type === 'pg' ? 'pgBalance' : 'usdtBalance';
            const balance = MiningApp.userData[balanceKey] || 0;

            if (!amount || isNaN(amount) || !address) { alert('Please fill all fields.'); return; }
            if (amount <= 0) { alert('Invalid amount.'); return; }
            if (amount > balance) { alert('Insufficient balance.'); return; }

            const req = {
                userId: currentUserId,
                amount: amount,
                type: type,
                address: address,
                method: method,
                status: 'Pending',
                timestamp: Date.now()
            };

            const updates = {};
            updates[balanceKey] = balance - amount;
            updates['totalWithdrawals'] = (MiningApp.userData.totalWithdrawals || 0) + 1;

            const withdrawReqRef = ref(db, 'withdrawalRequests');
            push(withdrawReqRef, req)
                .then(() => update(ref(db, `users/${currentUserId}`), updates))
                .then(() => {
                    alert('Withdrawal request submitted successfully!');
                    amountEl.value = '';
                    addressEl.value = '';
                })
                .catch(err => {
                    alert('Failed to submit request. Please try again.');
                    console.error(err);
                });
        }
        
        // --- LEVELING SYSTEM LOGIC ---
        const LevelSystem = {
            levels: {
                1: { nextLevel: 2, req: { pg: 5 }, reward: { permanentHP: 10 } },
                2: { nextLevel: 3, req: { pg: 15, usdt: 0.2, withdrawals: 1 }, reward: { permanentHP: 20 } },
                3: { nextLevel: 4, req: { pg: 30, usdt: 1, referrals: 5 }, reward: { permanentHP: 25, gameTokens: 5 } },
                4: { nextLevel: null }
            },
            
            async checkAndApplyLevelUp(userId, userData) {
                const currentLevel = userData.level || 1;
                if (!this.levels[currentLevel] || !this.levels[currentLevel].nextLevel) return;

                const nextLevelInfo = this.levels[currentLevel];
                const req = nextLevelInfo.req;

                const conditionsMet = 
                    (!req.pg || (userData.lifetimePgEarned || 0) >= req.pg) &&
                    (!req.usdt || (userData.lifetimeUsdtEarned || 0) >= req.usdt) &&
                    (!req.withdrawals || (userData.totalWithdrawals || 0) >= req.withdrawals) &&
                    (!req.referrals || (userData.totalReferrals || 0) >= req.referrals);
                
                if (conditionsMet) {
                    const { db, ref, update } = window.firebaseServices;
                    const reward = nextLevelInfo.reward;
                    const updates = {
                        level: nextLevelInfo.nextLevel,
                        permanentHP: (userData.permanentHP || 0) + (reward.permanentHP || 0),
                        gameTokens: (userData.gameTokens || 0) + (reward.gameTokens || 0)
                    };

                    await update(ref(db, 'users/' + userId), updates);
                    alert(`Congratulations! You've reached Level ${updates.level}! You received ${reward.permanentHP || 0} permanent HP and ${reward.gameTokens || 0} game tokens.`);
                }
            }
        };

        // --- MINING APP MODULE ---
        const MiningApp = {
            balanceEl: document.getElementById('balance'), statusEl: document.getElementById('status'),
            timerEl: document.getElementById('timer'), miningButton: document.getElementById('mining-button'),
            pgBalanceTopEl: document.getElementById('pg-balance-top'), usdBalanceTopEl: document.getElementById('usd-balance-top'),
            
            HP_TO_PG_PER_DAY: 0.1,
            MINING_SESSION_DURATION_MS: 6 * 60 * 60 * 1000,
            PG_TO_USD_RATE: 0.02,

            userData: {},
            miningInterval: null, timerInterval: null, totalHP: 0,

            init(userId, referrerId) {
                currentUserId = userId;
                this.miningButton.addEventListener('click', () => this.handleStartMiningClick());
                this.loadAndListenForUserData(userId, referrerId);
            },
            
            async loadAndListenForUserData(userId, referrerId) {
                const { db, ref, onValue, set, update, get } = window.firebaseServices;
                const userRef = ref(db, 'users/' + userId);

                onValue(userRef, (snapshot) => {
                    if (snapshot.exists()) {
                        this.userData = snapshot.val();
                        this.updateUI();
                        this.checkMiningState();
                        LevelSystem.checkAndApplyLevelUp(userId, this.userData);
                    } else {
                        const newUser = {
                            pgBalance: 0, usdtBalance: 0, level: 1, permanentHP: 5,
                            temporaryHP: {}, gameTokens: 5, lifetimePgEarned: 0, lifetimeUsdtEarned: 0,
                            totalWithdrawals: 0, totalReferrals: 0, adsWatchedToday: 0,
                            lastAdWatchDate: null, miningSessionEndTime: null, readMessages: {},
                            createdAt: new Date().toISOString()
                        };
                        set(userRef, newUser).then(() => {
                            if (referrerId) this.handleReferral(referrerId, userId);
                        });
                    }
                });
            },
            
            async handleReferral(referrerId, newUserId) {
                const { db, ref, update, get } = window.firebaseServices;
                const referrerRef = ref(db, 'users/' + referrerId);
                const snapshot = await get(referrerRef);
                if (!snapshot.exists()) return;

                const referrerData = snapshot.val();
                const now = Date.now();
                const expiry = now + 30 * 24 * 60 * 60 * 1000;
                
                const updates = {};
                updates[`temporaryHP/ref_${newUserId}`] = { amount: 2.5, expiresAt: expiry };
                updates.gameTokens = (referrerData.gameTokens || 0) + 1;
                updates.totalReferrals = (referrerData.totalReferrals || 0) + 1;
                
                await update(referrerRef, updates);
            },

            calculateTotalHP() {
                let total = this.userData.permanentHP || 0;
                const tempHP = this.userData.temporaryHP || {};
                const now = Date.now();
                const validTempHP = {};
                
                for(const key in tempHP){
                    if(tempHP[key].expiresAt > now){
                        total += tempHP[key].amount;
                        validTempHP[key] = tempHP[key];
                    }
                }

                if(Object.keys(validTempHP).length !== Object.keys(tempHP).length){
                     const { db, ref, set } = window.firebaseServices;
                     set(ref(db, `users/${currentUserId}/temporaryHP`), validTempHP);
                }
                this.totalHP = total;
            },

            checkMiningState() {
                if (this.userData.miningSessionEndTime && Date.now() < this.userData.miningSessionEndTime) {
                    this.resumeMining();
                } else {
                    this.stopMining(true);
                }
            },
            
            handleStartMiningClick() {
                this.calculateTotalHP();
                if(this.totalHP <= 0) { alert("You have no mining power (HP)."); return; }
                
                this.miningButton.disabled = true;
                this.miningButton.textContent = "Loading Ad...";
                
                showRandomAd(() => this._beginActualMiningSession(), (error) => {
                    alert("Ad failed. Please try again."); this.stopMining(false);
                });
            },
            
            _beginActualMiningSession() {
                const { db, ref, update } = window.firebaseServices;
                const endTime = Date.now() + this.MINING_SESSION_DURATION_MS;
                update(ref(db, 'users/' + currentUserId), { miningSessionEndTime: endTime }).then(() => this.resumeMining());
            },

            resumeMining() {
                this.statusEl.textContent = 'Active'; this.statusEl.className = 'mining';
                this.miningButton.disabled = true; this.miningButton.textContent = 'Mining...';
                this.calculateTotalHP();
                const ratePerSecond = (this.totalHP * this.HP_TO_PG_PER_DAY) / 86400;

                clearInterval(this.miningInterval);
                this.miningInterval = setInterval(() => {
                    const { db, ref, update } = window.firebaseServices;
                    const newPgBalance = (this.userData.pgBalance || 0) + ratePerSecond;
                    const newLifetimePg = (this.userData.lifetimePgEarned || 0) + ratePerSecond;
                    update(ref(db, `users/${currentUserId}`), { pgBalance: newPgBalance, lifetimePgEarned: newLifetimePg });
                }, 1000);
                
                clearInterval(this.timerInterval);
                this.timerInterval = setInterval(() => this.updateTimer(), 1000);
                this.updateTimer();
            },
            
            stopMining(sessionExpired) {
                clearInterval(this.miningInterval); clearInterval(this.timerInterval);
                this.statusEl.textContent = sessionExpired ? 'Session Ended' : 'Stopped';
                this.statusEl.className = 'stopped';
                this.timerEl.textContent = 'Ready to start';
                this.miningButton.disabled = false; this.miningButton.textContent = 'Start Mining';
                
                if(sessionExpired && this.userData.miningSessionEndTime) {
                    const { db, ref, update } = window.firebaseServices;
                    update(ref(db, `users/${currentUserId}`), { miningSessionEndTime: null });
                }
            },

            updateTimer() {
                const endTime = this.userData.miningSessionEndTime;
                if (!endTime || Date.now() >= endTime) { this.stopMining(true); return; }
                const remainingTime = endTime - Date.now();
                const h = Math.floor(remainingTime / 3600000);
                const m = Math.floor((remainingTime % 3600000) / 60000);
                const s = Math.floor((remainingTime % 60000) / 1000);
                this.timerEl.textContent = `Time Left: ${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
            },

            updateUI() {
                const pgBal = this.userData.pgBalance || 0;
                const usdtBal = this.userData.usdtBalance || 0;
                this.balanceEl.textContent = `${pgBal.toFixed(4)} PG`;
                this.pgBalanceTopEl.textContent = pgBal.toFixed(4);
                this.usdBalanceTopEl.textContent = (usdtBal + (pgBal * this.PG_TO_USD_RATE)).toFixed(2);
                document.getElementById('referral-link').value = `http://t.me/PGenix_Bot/PGenix?startapp=ref_${currentUserId}`;
                InboxApp.checkForUnread(this.userData.messages, this.userData.readMessages);
                
                document.getElementById('withdraw-pg-balance').textContent = pgBal.toFixed(4);
                document.getElementById('withdraw-usdt-balance').textContent = usdtBal.toFixed(6);
            },
            
            handleWatchAd() {
                const today = new Date().toISOString().slice(0, 10);
                let adsWatched = this.userData.adsWatchedToday || 0;
                if (this.userData.lastAdWatchDate !== today) adsWatched = 0;
                if (adsWatched >= 15) { alert('Daily ad limit reached.'); return; }

                showRandomAd(() => {
                    adsWatched++;
                    const { db, ref, update, set, push } = window.firebaseServices;
                    const userRef = ref(db, 'users/' + currentUserId);
                    const rand = Math.random();
                    let rewardMsg = "You got ";
                    let updates = { adsWatchedToday: adsWatched, lastAdWatchDate: today };

                    if (rand < 0.05) { // 5% Game Token
                        updates.gameTokens = (this.userData.gameTokens || 0) + 1;
                        rewardMsg += "1 Game Token (RARE)!";
                    } else if (rand < 0.45) { // 40% HP
                        const expiry = Date.now() + 24 * 60 * 60 * 1000;
                        const newHpRef = push(ref(db, `users/${currentUserId}/temporaryHP`));
                        set(newHpRef, { amount: 1.5, expiresAt: expiry });
                        rewardMsg += `1.5 Mining HP for 24 hours!`;
                    } else if (rand < 0.85) { // 40% USDT
                        const usdtAmount = Math.random() * (0.002 - 0.0001) + 0.0001;
                        updates.usdtBalance = (this.userData.usdtBalance || 0) + usdtAmount;
                        updates.lifetimeUsdtEarned = (this.userData.lifetimeUsdtEarned || 0) + usdtAmount;
                        rewardMsg += `${usdtAmount.toFixed(6)} USDT!`;
                    } else { // 15% PG Coin
                        const pgAmount = 0.001;
                        updates.pgBalance = (this.userData.pgBalance || 0) + pgAmount;
                        updates.lifetimePgEarned = (this.userData.lifetimePgEarned || 0) + pgAmount;
                        rewardMsg += `${pgAmount.toFixed(4)} PG Coin!`;
                    }
                    
                    update(userRef, updates);
                    alert(rewardMsg + `\nAds watched today: ${adsWatched}/15`);
                },
                (error) => alert("Ad failed. Please try again.")
                );
            }
        };

        const ProfileApp = {
            render(userData) {
                document.getElementById('lifetime-pg').textContent = (userData.lifetimePgEarned || 0).toFixed(4);
                document.getElementById('lifetime-usdt').textContent = (userData.lifetimeUsdtEarned || 0).toFixed(6);
                
                const level = userData.level || 1;
                document.getElementById('current-level').textContent = level;
                const nextLevelInfo = LevelSystem.levels[level];

                if (!nextLevelInfo || !nextLevelInfo.nextLevel) {
                    document.getElementById('next-level-label').textContent = "Max Level";
                    document.getElementById('level-progress-bar').style.width = "100%";
                    document.getElementById('progress-label').textContent = "Completed";
                    document.getElementById('level-req-list').innerHTML = `<li>You are at the maximum level!</li>`;
                    return;
                }
                
                document.getElementById('next-level-label').textContent = `To Level ${nextLevelInfo.nextLevel}`;
                const req = nextLevelInfo.req;
                const reqListEl = document.getElementById('level-req-list');
                reqListEl.innerHTML = '';
                
                let completedCount = 0;
                const totalReqs = Object.keys(req).length;
                const check = (val, target) => val >= target;

                if (req.pg) { const isDone = check(userData.lifetimePgEarned || 0, req.pg); if(isDone) completedCount++; reqListEl.innerHTML += `<li class="${isDone ? 'completed' : ''}">PG Earned: ${(userData.lifetimePgEarned || 0).toFixed(2)} / ${req.pg}</li>`; }
                if (req.usdt) { const isDone = check(userData.lifetimeUsdtEarned || 0, req.usdt); if(isDone) completedCount++; reqListEl.innerHTML += `<li class="${isDone ? 'completed' : ''}">USDT Earned: ${(userData.lifetimeUsdtEarned || 0).toFixed(4)} / ${req.usdt}</li>`; }
                if (req.withdrawals) { const isDone = check(userData.totalWithdrawals || 0, req.withdrawals); if(isDone) completedCount++; reqListEl.innerHTML += `<li class="${isDone ? 'completed' : ''}">Withdrawals: ${userData.totalWithdrawals || 0} / ${req.withdrawals}</li>`; }
                if (req.referrals) { const isDone = check(userData.totalReferrals || 0, req.referrals); if(isDone) completedCount++; reqListEl.innerHTML += `<li class="${isDone ? 'completed' : ''}">Referrals: ${userData.totalReferrals || 0} / ${req.referrals}</li>`; }
                
                const progress = totalReqs > 0 ? (completedCount / totalReqs) * 100 : 100;
                document.getElementById('level-progress-bar').style.width = `${progress}%`;
                document.getElementById('progress-label').textContent = `${completedCount}/${totalReqs} tasks`;
            }
        };
        
        const InboxApp = {
            allMessages: {},
            checkForUnread(messages = {}, readMessages = {}) {
                const { db, ref, onValue } = window.firebaseServices;
                onValue(ref(db, 'messages/ALL'), (snapshot) => {
                    const broadcastMessages = snapshot.val() || {};
                    const allUserMessages = {...broadcastMessages, ...(messages)};
                    this.allMessages = allUserMessages;
                    
                    const unreadCount = Object.keys(allUserMessages).filter(msgId => !readMessages[msgId]).length;
                    document.getElementById('unread-dot').style.display = unreadCount > 0 ? 'block' : 'none';
                });
            },
            render(messages = {}, readMessages = {}) {
                const listEl = document.getElementById('inbox-list');
                listEl.innerHTML = '';
                const sortedMessages = Object.entries(this.allMessages).sort((a,b) => b[1].timestamp - a[1].timestamp);

                if (sortedMessages.length === 0) { listEl.innerHTML = '<div class="no-data">No messages yet.</div>'; return; }

                sortedMessages.forEach(([id, msg]) => {
                    const isUnread = !readMessages[id];
                    const card = document.createElement('div');
                    card.className = `message-card ${isUnread ? 'unread' : ''}`;
                    card.innerHTML = `<div class="message-header"><span class="message-title">${msg.title}</span><span class="message-date">${new Date(msg.timestamp).toLocaleDateString()}</span></div><div class="message-body">${msg.body}</div>`;
                    card.onclick = () => this.markAsRead(id);
                    listEl.appendChild(card);
                });
            },
            markAsRead(messageId) {
                const { db, ref, update } = window.firebaseServices;
                const updates = {};
                updates[`readMessages/${messageId}`] = true;
                update(ref(db, `users/${currentUserId}`), updates);
            }
        };

        const GameApp = {
            showStartScreen() {
                const tokens = MiningApp.userData.gameTokens || 0;
                document.getElementById('game-token-count').innerHTML = `You have <span>${tokens}</span> Game Tokens.`;
                document.getElementById('start-game-btn').disabled = tokens <= 0;
            },
            consumeTokenAndStart() {
                const tokens = MiningApp.userData.gameTokens || 0;
                if(tokens <= 0) return;

                const { db, ref, update } = window.firebaseServices;
                update(ref(db, `users/${currentUserId}`), { gameTokens: tokens - 1 });
                
                document.getElementById('game-start-screen').style.display = 'none';
                document.getElementById('game-container').style.display = 'block';
                
                if (!SnowCatcherGame.isInitialized) SnowCatcherGame.init();
                SnowCatcherGame.startGame();
            }
        };
        
        const SnowCatcherGame = {
            isInitialized: false, score: 0, usdtScore: 0.0, timeRemaining: 60,
            init() {
                if(this.isInitialized) return;
                this.gameContainer = document.getElementById('game-container');
                this.scoreSpan = document.getElementById('score');
                this.usdtScoreSpan = document.getElementById('usdt-score');
                this.timerSpan = document.getElementById('timer-value');
                this.gameOverDiv = document.getElementById('game-over');
                this.finalScoreSpan = document.getElementById('final-score');
                this.finalUsdtScoreSpan = document.getElementById('final-usdt-score');
                this.restartButton = document.getElementById('restart-button');
                
                this.gameContainer.addEventListener('pointerdown', (e) => { if (e.target.matches('.falling-object')) this.handleObjectClick(e.target); });
                this.restartButton.addEventListener('click', () => {
                    this.gameOverDiv.style.display = 'none';
                    GameApp.consumeTokenAndStart();
                });
                this.isInitialized = true;
            },
            createFallingObject() {
                if (this.isGameOver) return;
                const r = Math.random();
                this.createObject(r < 0.08 ? '💣' : (r < 0.15 ? '💸' : '❄️'), r < 0.08 ? 'bomb' : (r < 0.15 ? 'coin' : 'snowflake'));
            },
            createObject(emoji, type) {
                const obj = document.createElement('div');
                obj.className = 'falling-object';
                obj.innerHTML = emoji;
                obj.dataset.type = type;
                obj.style.left = Math.random() * (this.gameContainer.offsetWidth - 50) + 'px';
                obj.style.top = '-50px';
                obj.dataset.speed = Math.random() * 1.5 + this.baseSpeed;
                if (type === 'coin') obj.dataset.value = Math.random() * (0.001 - 0.0001) + 0.0001;
                this.gameContainer.appendChild(obj);
            },
            handleObjectClick(obj) {
                if (this.isGameOver || obj.classList.contains('collected')) return;
                obj.classList.add('collected');
                setTimeout(() => obj.remove(), 300);
                if (obj.dataset.type === 'snowflake') { this.score += 10; this.scoreSpan.textContent = this.score; } 
                else if (obj.dataset.type === 'coin') { this.usdtScore += parseFloat(obj.dataset.value); this.usdtScoreSpan.textContent = this.usdtScore.toFixed(6); } 
                else if (obj.dataset.type === 'bomb') this.endGame('bomb');
            },
            gameLoop() {
                document.querySelectorAll('.falling-object:not(.collected)').forEach(obj => {
                    let top = parseFloat(obj.style.top) + parseFloat(obj.dataset.speed);
                    obj.style.top = top + 'px';
                    if (top > this.gameContainer.offsetHeight) { obj.remove(); }
                });
            },
            startGame() {
                this.isGameOver = false; this.score = 0; this.usdtScore = 0.0; this.timeRemaining = 60; this.baseSpeed = 1.0;
                this.scoreSpan.textContent = this.score; this.usdtScoreSpan.textContent = this.usdtScore.toFixed(6);
                this.timerSpan.textContent = this.timeRemaining; this.gameOverDiv.style.display = 'none'; this.gameContainer.style.cursor = 'crosshair';
                document.querySelectorAll('.falling-object').forEach(el => el.remove());

                this.gameLoopInterval = setInterval(() => this.gameLoop(), 16);
                this.objectCreationInterval = setInterval(() => this.createFallingObject(), 800);
                this.gameTimer = setTimeout(() => this.endGame('time'), 60000);
                this.countdownInterval = setInterval(() => {
                    this.timeRemaining--; this.timerSpan.textContent = this.timeRemaining; this.baseSpeed += 0.05;
                    if(this.timeRemaining <= 0) clearInterval(this.countdownInterval);
                }, 1000);
            },
            endGame(reason) {
                if (this.isGameOver) return; this.isGameOver = true;
                clearInterval(this.gameLoopInterval); clearInterval(this.objectCreationInterval); clearInterval(this.countdownInterval); clearTimeout(this.gameTimer);
                
                if (reason === 'bomb') { this.score = 0; this.usdtScore = 0.0; }

                this.finalScoreSpan.textContent = this.score;
                this.finalUsdtScoreSpan.textContent = this.usdtScore.toFixed(6);
                
                const { db, ref, update } = window.firebaseServices;
                const updates = {};
                const pgFromScore = this.score / 1000; // 1000 score = 1 PG
                updates.pgBalance = (MiningApp.userData.pgBalance || 0) + pgFromScore;
                updates.lifetimePgEarned = (MiningApp.userData.lifetimePgEarned || 0) + pgFromScore;
                if (this.usdtScore > 0) {
                    updates.usdtBalance = (MiningApp.userData.usdtBalance || 0) + this.usdtScore;
                    updates.lifetimeUsdtEarned = (MiningApp.userData.lifetimeUsdtEarned || 0) + this.usdtScore;
                }
                update(ref(db, 'users/' + currentUserId), updates);

                this.gameOverDiv.style.display = 'block';
                this.restartButton.disabled = (MiningApp.userData.gameTokens || 0) <= 1; // Check if tokens left for another game
            }
        };

        document.addEventListener('DOMContentLoaded', () => {
            const adexiumScript = document.createElement('script');
            adexiumScript.src = "https://cdn.tgads.space/assets/js/adexium-widget.min.js";
            adexiumScript.onload = () => {
                try {
                    new AdexiumWidget({wid: '591a49b2-631d-4270-ad75-bf7afd247d5f', adFormat: 'interstitial'}).autoMode();
                } catch (e) { console.error("Adexium widget failed:", e); }
            };
            document.head.appendChild(adexiumScript);

            if (window.firebaseServices) {
                const tg = window.Telegram.WebApp;
                tg.ready();
                tg.expand();

                let userId, referrerId = null;
                const startParam = tg.initDataUnsafe?.start_param;
                
                if (startParam && startParam.startsWith('ref_')) { referrerId = startParam.substring(4); }
                if (tg.initDataUnsafe?.user?.id) { userId = "tg_user_" + tg.initDataUnsafe.user.id; } 
                else { userId = "web_user_" + Date.now(); }
                
                MiningApp.init(userId, referrerId);
                showView('mining-section');
            } else {
                console.error("Firebase services not available.");
            }
        });
    </script>
</body>
</html>